<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="https://cdn-icons-png.flaticon.com/512/891/891419.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <!-- Firebase SDK Versión 9 (compatibilidad con navegador) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- SheetJS para exportar a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* ==============================================
           PALETA DE COLORES AZUL CORPORATIVO MODERNO
           ============================================== */
        :root {
            --primary-blue: #1a56db;        /* Azul principal más vibrante */
            --primary-dark: #1e429f;        /* Azul oscuro */
            --secondary-blue: #3b82f6;      /* Azul secundario */
            --accent-blue: #93c5fd;         /* Azul claro/acento */
            --light-blue: #dbeafe;          /* Azul muy claro para fondos */
            --success: #10b981;             /* Verde éxito - moderno */
            --warning: #f59e0b;              /* Ámbar advertencia - moderno */
            --danger: #ef4444;               /* Rojo peligro - moderno */
            --info: #8b5cf6;                  /* Violeta info - moderno */
            --light: #f8fafc;                 /* Gris muy claro */
            --dark: #1f2937;                  /* Gris oscuro moderno */
            --text-primary: #111827;          /* Texto principal */
            --text-secondary: #6b7280;        /* Texto secundario */
            --border: #e5e7eb;                 /* Bordes claros */
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            --card-shadow-hover: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* MODIFICACIÓN: Prevenir que los modales se cierren al hacer clic fuera */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
            backdrop-filter: blur(4px);
        }
        
        /* MODIFICACIÓN: Prevenir que el modal se cierre al hacer clic en el fondo */
        .modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        /* ==============================================
           RESET Y ESTILOS BASE
           ============================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f9fafb;
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 0.9375rem;
        }
        
        /* ==============================================
           HEADER MODERNO
           ============================================== */
        header {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark));
            color: white;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            border-radius: 16px;
            box-shadow: var(--card-shadow-hover);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle at center, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
            position: relative;
            z-index: 1;
        }
        
        h1 {
            font-size: 1.75rem;
            margin-bottom: 0.25rem;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            padding: 8px 16px;
            border-radius: 20px;
            background-color: rgba(255, 255, 255, 0.15);
            font-weight: 500;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 50px;
            color: white;
            font-weight: 500;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-info i {
            font-size: 1.2rem;
        }
        
        .btn-logout {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 6px;
            transition: background-color 0.3s;
        }
        
        .btn-logout:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* ==============================================
           CONTENEDOR PRINCIPAL
           ============================================== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        
        /* ==============================================
           TARJETAS DE ESTADÍSTICAS MODERNAS
           ============================================== */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }
        
        .stat-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-shadow-hover);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-blue);
        }
        
        .stat-icon {
            font-size: 2.25rem;
            margin-right: 1rem;
            width: 64px;
            height: 64px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .bodega-icon {
            background: linear-gradient(135deg, rgba(26, 86, 219, 0.1), rgba(59, 130, 246, 0.2));
            color: var(--primary-blue);
        }
        
        .tienda-icon {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2));
            color: var(--success);
        }
        
        .proveedor-icon {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.2));
            color: var(--info);
        }
        
        .historial-icon {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.2));
            color: var(--warning);
        }
        
        .stat-info h3 {
            font-size: 1.75rem;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }
        
        .stat-info p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* ==============================================
           BOTONES MODERNOS
           ============================================== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            letter-spacing: 0.3px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #34d399);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #fbbf24);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info), #a78bfa);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #f87171);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border);
        }
        
        /* ==============================================
           BUSCADORES MODERNOS
           ============================================== */
        .search-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border);
            align-items: center;
        }
        
        .search-box {
            flex-grow: 1;
            position: relative;
            min-width: 250px;
        }
        
        .search-box input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 3rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 0.9375rem;
            transition: all 0.2s;
            background: white;
        }
        
        .search-box input:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 86, 219, 0.1);
        }
        
        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        
        /* ==============================================
           PESTAÑAS MODERNAS
           ============================================== */
        .tabs-container {
            position: relative;
            margin-bottom: 2rem;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            background: white;
            padding: 0.5rem;
            border-radius: 12px 12px 0 0;
            box-shadow: var(--card-shadow);
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        
        .tabs::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }
        
        /* Indicadores visuales para pestañas fuera de vista */
        .tabs-container::before,
        .tabs-container::after {
            content: '';
            position: absolute;
            top: 0.5rem;
            bottom: 0;
            width: 20px;
            pointer-events: none;
            z-index: 1;
        }
        
        .tabs-container::before {
            left: 0;
            background: linear-gradient(90deg, white, transparent);
        }
        
        .tabs-container::after {
            right: 0;
            background: linear-gradient(90deg, transparent, white);
        }
        
        .tab-btn {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
            transition: all 0.3s;
            border-radius: 8px;
            margin: 0 2px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab-btn:hover {
            color: var(--primary-blue);
            background: rgba(26, 86, 219, 0.05);
        }
        
        .tab-btn.active {
            color: var(--primary-blue);
            background: rgba(26, 86, 219, 0.1);
            position: relative;
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -11px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-blue);
            border-radius: 3px 3px 0 0;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ==============================================
           TABLAS MODERNAS
           ============================================== */
        .inventory-table {
            background-color: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            overflow-x: auto;
            border: 1px solid var(--border);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        thead {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            font-weight: 600;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
        }
        
        th i {
            margin-left: 5px;
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        tbody tr {
            transition: background-color 0.2s;
        }
        
        tbody tr:hover {
            background-color: rgba(26, 86, 219, 0.03);
        }
        
        tbody tr:nth-child(even) {
            background-color: #fafafa;
        }
        
        tbody tr:nth-child(even):hover {
            background-color: rgba(26, 86, 219, 0.05);
        }
        
        /* MEJORA: Números de existencia en color verde */
        .stock-cell {
            font-weight: bold;
            color: var(--success) !important;
            position: relative;
            padding-left: 20px;
        }
        
        /* Estilos adicionales para diferentes niveles de stock */
        .stock-cell::before {
            display: none;
        }

        .stock-cell.critico::before {
            display: block;
        }
        
        .stock-cell.critico {
            color: var(--danger) !important;
        }
        
        .stock-cell.critico::before {
            background-color: var(--danger);
        }
        
        .stock-cell.bajo {
            color: var(--warning) !important;
        }
        
        .stock-cell.bajo::before {
            background-color: var(--warning);
        }
        
        /* ==============================================
           ACCIONES EN TABLAS
           ============================================== */
        .actions-cell {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-btn {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }
        
        .edit-btn {
            background-color: rgba(26, 86, 219, 0.1);
            color: var(--primary-blue);
        }
        
        .delete-btn {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .transfer-btn {
            background-color: rgba(139, 92, 246, 0.1);
            color: var(--info);
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* ==============================================
           MODALES MODERNOS
           ============================================== */
        .modal-content {
            background-color: white;
            padding: 2.5rem;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid var(--border);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-lg {
            max-width: 800px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-header h2 {
            color: var(--primary-blue);
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .close-modal:hover {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 0.9375rem;
            transition: all 0.2s;
            background: white;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 86, 219, 0.1);
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        /* ==============================================
           SCANNER MODERNO
           ============================================== */
        .scanner-container {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, var(--light-blue), white);
            border-radius: 16px;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }
        
        .scanner-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.125rem;
            text-align: center;
            border: 2px solid var(--border);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            transition: all 0.3s;
            background: white;
        }
        
        .scanner-input:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 86, 219, 0.1);
        }
        
        /* ==============================================
           PROVEEDORES MODERNOS
           ============================================== */
        .proveedor-search-container {
            margin-bottom: 2rem;
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border);
        }
        
        .proveedor-search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
        }
        
        /* MEJORA: Barra de búsqueda de proveedor mejorada */
        .proveedor-search-box {
            flex: 1;
            position: relative;
        }
        
        .proveedor-search-box input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 3rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 0.9375rem;
            background: white;
        }
        
        .proveedor-search-box input:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 86, 219, 0.1);
        }
        
        .proveedor-search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        
        .proveedor-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--card-shadow-hover);
            z-index: 100;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .proveedor-suggestion {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .proveedor-suggestion:hover {
            background-color: var(--light-blue);
        }
        
        .proveedor-count {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: var(--light);
            padding: 2px 8px;
            border-radius: 12px;
        }
        
        .proveedor-count-badge {
            background: var(--info);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .proveedor-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border);
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .proveedor-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
        }
        
        /* ==============================================
           HISTORIAL
           ============================================== */
        .historial-item {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border);
            transition: all 0.3s;
        }
        
        .historial-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
        }
        
        .historial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .historial-tipo {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tipo-transferencia {
            background-color: rgba(139, 92, 246, 0.1);
            color: var(--info);
        }
        
        .tipo-importacion {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .tipo-actualizacion {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .historial-fecha {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        /* ==============================================
           INFORMACIÓN MODERNA
           ============================================== */
        .info-section {
            background: white;
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }
        
        .info-section h3 {
            color: var(--primary-blue);
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--light-blue);
            padding-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .info-card {
            background: linear-gradient(135deg, #f8fafc, white);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }
        
        .info-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--card-shadow);
        }
        
        /* ==============================================
           CÓDIGOS DE BARRAS MÚLTIPLES
           ============================================== */
        .barcodes-container {
            margin-top: 0.5rem;
            background: #f8fafc;
            padding: 1rem;
            border-radius: 10px;
            border: 1px dashed var(--border);
        }
        
        .barcode-item {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }
        
        .barcode-item input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: white;
        }
        
        .barcode-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 8px;
        }
        
        /* ==============================================
           ANIMACIONES
           ============================================== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        .spinner-large {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(26, 86, 219, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-blue);
            animation: spin 1s ease-in-out infinite;
        }
        
        /* ==============================================
           RESPONSIVE DESIGN
           ============================================== */
        @media (max-width: 768px) {
            header {
                padding: 1.25rem;
            }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .modal-content {
                padding: 1.5rem;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .toolbar, .search-container {
                flex-direction: column;
            }
            
            .search-box {
                width: 100%;
                min-width: unset;
            }
            
            .actions-cell {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
            
            .proveedor-card {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .barcode-item {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .barcode-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .tabs-container::before,
            .tabs-container::after {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .stats {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                font-size: 0.75rem;
            }
            
            .tab-btn {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Main Application -->
    <div id="mainApp">
        <div class="container">
            <header>
                <div class="header-content">
                    <div>
                        <h1><i class="fas fa-warehouse"></i> Sistema de Inventario</h1>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div id="connectionStatus" class="connection-status">
                            <i class="fas fa-sync fa-spin"></i> Conectando...
                        </div>
                        <div class="user-info">
                            <i class="fas fa-user-circle"></i>
                            <span id="currentUsername">Usuario</span>
                            <span id="userRoleBadge" class="role-badge" style="background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 20px; font-size: 0.7rem;"></span>
                            <button id="btnLogout" class="btn-logout">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- MEJORA: Contenedor de pestañas con scrollbar oculto -->
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="inventario">
                        <i class="fas fa-boxes"></i> Inventario
                    </button>
                    <button class="tab-btn" data-tab="proveedores">
                        <i class="fas fa-truck"></i> Por Proveedor
                    </button>
                    <button class="tab-btn" data-tab="gestionProveedores">
                        <i class="fas fa-user-tie"></i> Gestión Proveedores
                    </button>
                    <button class="tab-btn" data-tab="actualizarStock">
                        <i class="fas fa-sync-alt"></i> Actualizar Stock
                    </button>
                    <button class="tab-btn" data-tab="historial">
                        <i class="fas fa-history"></i> Historial
                    </button>
                    <button class="tab-btn" data-tab="importar">
                        <i class="fas fa-file-import"></i> Importar/Exportar
                    </button>
                    <button class="tab-btn" data-tab="informacion">
                        <i class="fas fa-info-circle"></i> Información
                    </button>
                </div>
            </div> 
            
            <!-- PESTAÑA INVENTARIO - MODIFICADA: Sin toolbar, botón agregar en search bar -->
            <div class="tab-content active" id="inventarioTab">
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Buscar productos...">
                    </div>
                    
                    <!-- Botón Agregar Producto (solo visible para admin) -->
                    <button class="btn btn-primary" id="btnAddProductInventario" style="display: none;">
                        <i class="fas fa-plus"></i> Agregar Producto
                    </button>
                    
                    <!-- Botón Actualizar -->
                    <button class="btn btn-primary" id="btnRefresh">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                
                <div class="inventory-table">
                    <table>
                        <thead>
                            <tr>
                                <th data-sort="sku">SKU <i class="fas fa-sort"></i></th>
                                <th data-sort="name">Producto <i class="fas fa-sort"></i></th>
                                <th data-sort="barcode">Cód. Barra <i class="fas fa-sort"></i></th>
                                <th data-sort="proveedor">Proveedor <i class="fas fa-sort"></i></th>
                                <th data-sort="stock">Stock Bodega <i class="fas fa-sort"></i></th>
                                <th data-sort="envio">Último Envío a Tienda <i class="fas fa-sort"></i></th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <tr id="loadingRow">
                                <td colspan="7" class="loading-spinner">
                                    <div class="spinner-large"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="proveedoresTab">
                <!-- MEJORA: Barra de búsqueda de proveedor mejorada -->
                <div class="proveedor-search-container">
                    <div class="proveedor-search-header">
                        <div class="proveedor-search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="proveedorSearchInput" placeholder="Buscar proveedor...">
                            <div class="proveedor-suggestions" id="proveedorSuggestions">
                            </div>
                        </div>
                        <button class="btn btn-success" id="btnExportarProveedorExcel">
                            <i class="fas fa-file-excel"></i> Exportar a Excel
                        </button>
                    </div>
                    <div id="proveedorSelected" style="font-weight: 600; color: var(--info);">
                        Mostrando todos los proveedores
                    </div>
                </div>
                
                <!-- MODIFICACIÓN: Filtros de ordenamiento para pestaña proveedores -->
                <div class="search-container" style="margin-bottom: 15px;">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="proveedorProductSearch" placeholder="Buscar productos en esta pestaña...">
                    </div>
                    <button class="btn btn-primary" id="btnRefreshProveedores">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                
                <div class="inventory-table">
                    <table>
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Producto</th>
                                <th>Cód. Barra</th>
                                <th>Proveedor</th>
                                <th>Stock Bodega</th>
                                <th>Último Envío a Tienda</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="proveedorTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="gestionProveedoresTab">
                <div class="toolbar">
                    <button class="btn btn-primary" id="btnAddProveedor" style="display: none;">
                        <i class="fas fa-plus"></i> Agregar Proveedor
                    </button>
                    <button class="btn btn-info" id="btnExportarProveedores">
                        <i class="fas fa-file-export"></i> Exportar Proveedores
                    </button>
                    <button class="btn btn-primary" id="btnRefreshGestionProveedores">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                
                <div id="proveedoresContainer">
                </div>
            </div>
            
            <div class="tab-content" id="actualizarStockTab">
                <div class="toolbar">
                    <button class="btn btn-primary" id="btnRefreshActualizarStock">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                
                <div class="form-group">
                    <h3><i class="fas fa-sync-alt"></i> Actualización Masiva de Stock</h3>
                    <p>Pega los datos en el formato: <strong>SKU | Existencia Bodega | Existencia Tienda</strong></p>
                    <p>Ejemplo: <code>DPI001 | 10 | 5</code></p>
                    <textarea id="actualizarStockData" rows="15" placeholder="DPI001 | 10 | 5&#10;DPI002 | 15 | 8&#10;DPI003 | 20 | 12"></textarea>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="actualizarSoloBodega">
                    <label for="actualizarSoloBodega">Actualizar solo stock de bodega (ignorar tienda)</label>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-warning" id="btnProcesarActualizacion" style="width: 100%; display: none;">
                        <i class="fas fa-sync-alt"></i> Procesar Actualización de Stock
                    </button>
                </div>
                
                <div id="actualizacionResultado" style="margin-top: 20px; display: none;">
                </div>
            </div>
            
            <div class="tab-content" id="historialTab">
                <div class="toolbar">
                    <button class="btn btn-danger" id="btnLimpiarHistorial" style="display: none;">
                        <i class="fas fa-trash"></i> Limpiar Historial
                    </button>
                    <button class="btn btn-primary" id="btnRefreshHistorial">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                
                <div id="historialContainer">
                    <!-- El historial se cargará aquí dinámicamente -->
                </div>
            </div>
            
            <!-- PESTAÑA IMPORTAR - MODIFICADA: Con botones Agregar Producto e Importar Rápido -->
            <div class="tab-content" id="importarTab">
                <div class="toolbar">
                    <button class="btn btn-primary" id="btnRefreshImportar">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                    
                    <!-- Botón Agregar Producto en pestaña Importar -->
                    <button class="btn btn-primary" id="btnAddProductImportar" style="display: none;">
                        <i class="fas fa-plus"></i> Agregar Producto
                    </button>
                    
                    <!-- Botón Importar Rápido en pestaña Importar -->
                    <button class="btn btn-info" id="btnImportarRapidoImportar" style="display: none;">
                        <i class="fas fa-file-import"></i> Importar Rápido
                    </button>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <h3><i class="fas fa-file-import"></i> Importar Datos</h3>
                        <p>Sube un archivo JSON con el formato correcto para cargar productos al sistema.</p>
                        
                        <div class="file-upload" id="fileUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Arrastra y suelta tu archivo JSON aquí o haz clic para seleccionar</p>
                            <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
                            <p class="subtitle" style="margin-top: 10px;">Formato esperado: SKU | Producto | Cód. Barra | Existencia</p>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="importarActualizarStock">
                            <label for="importarActualizarStock">Actualizar stock existente (en lugar de sumar)</label>
                        </div>
                        
                        <div class="form-group">
                            <label for="importProveedor">Proveedor (se aplicará a todos los productos)</label>
                            <select id="importProveedor">
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-success" id="btnImportarJSON" style="width: 100%; display: none;">
                                <i class="fas fa-upload"></i> Importar Archivo JSON
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group" style="flex: 1;">
                        <h3><i class="fas fa-file-export"></i> Exportar Datos</h3>
                        <p>Descarga los datos actuales del inventario en diferentes formatos.</p>
                        
                        <div class="form-group">
                            <label for="exportFormat">Formato de Exportación</label>
                            <select id="exportFormat">
                                <option value="json">JSON Completo</option>
                                <option value="formatoProveedor">Formato Proveedor</option>
                                <option value="csv">CSV</option>
                                <option value="excel">Excel</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-primary" id="btnExportarJSON" style="width: 100%;">
                                <i class="fas fa-download"></i> Exportar Datos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="informacionTab">
                <div class="toolbar">
                    <button class="btn btn-primary" id="btnRefreshInformacion">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                
                <div class="info-section">
                    <h3><i class="fas fa-info-circle"></i> Información del Sistema</h3>
                    
                    <div class="stats" style="margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-icon bodega-icon">
                                <i class="fas fa-warehouse"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalBodega">0</h3>
                                <p>Productos en bodega</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon tienda-icon">
                                <i class="fas fa-store"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalTienda">0</h3>
                                <p>Productos en tienda</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon proveedor-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalProveedores">0</h3>
                                <p>Proveedores</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon historial-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalMovimientos">0</h3>
                                <p>Movimientos</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-card">
                            <h4><i class="fas fa-cogs"></i> Características del Sistema</h4>
                            <ul>
                                <li><strong>Inventario:</strong> Gestión completa de productos</li>
                                <li><strong>Proveedores:</strong> Administración y filtrado</li>
                                <li><strong>Actualización:</strong> Stock masivo y rápido</li>
                                <li><strong>Historial:</strong> Registro de movimientos</li>
                                <li><strong>Importación:</strong> Carga de datos desde archivos</li>
                                <li><strong>Exportación:</strong> Descarga en múltiples formatos</li>
                            </ul>
                        </div>
                        
                        <div class="info-card">
                            <h4><i class="fas fa-shield-alt"></i> Seguridad y Acceso</h4>
                            <ul>
                                <li><strong>Sistema seguro:</strong> Autenticación de usuarios</li>
                                <li><strong>Controles:</strong> Permisos según roles</li>
                                <li><strong>Backup:</strong> Datos sincronizados en la nube</li>
                                <li><strong>Confidencialidad:</strong> Protección de información</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal para agregar/editar producto -->
        <div id="productModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Agregar Producto</h2>
                    <span class="close-modal" id="closeModal">&times;</span>
                </div>
                <form id="productForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productSKU">SKU *</label>
                            <input type="text" id="productSKU" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="productBarCode">Código de Barras Principal *</label>
                            <input type="text" id="productBarCode" required>
                        </div>
                    </div>
                    
                    <!-- MODIFICACIÓN: Códigos de barras adicionales -->
                    <div class="form-group">
                        <label>Códigos de Barras Adicionales</label>
                        <div class="barcodes-container" id="barcodesContainer">
                            <!-- Los códigos de barras adicionales se agregarán aquí dinámicamente -->
                        </div>
                        <button type="button" class="btn btn-small btn-primary" id="btnAddBarcode" style="margin-top: 10px;">
                            <i class="fas fa-plus"></i> Agregar Código de Barras
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="productName">Nombre del Producto *</label>
                        <input type="text" id="productName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="productProveedor">Proveedor *</label>
                        <select id="productProveedor" required>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="stockBodega">Stock en Bodega *</label>
                            <input type="number" id="stockBodega" min="0" value="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="stockTienda">Stock en Tienda *</label>
                            <input type="number" id="stockTienda" min="0" value="0" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary" id="btnSubmitProduct" style="width: 100%;">
                            <i class="fas fa-save"></i> Guardar Producto
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modal para escanear/transferir -->
        <div id="scannerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-barcode"></i> Escanear Producto</h2>
                    <span class="close-modal" id="closeScannerModal">&times;</span>
                </div>
                
                <div class="scanner-container">
                    <p>Escanee el código de barras o ingrese el SKU del producto</p>
                    <input type="text" id="scannerInput" class="scanner-input" placeholder="Escanee o escriba el código..." autofocus>
                    
                    <div class="scanner-buttons">
                        <button class="btn btn-info" id="btnBuscarProducto">
                            <i class="fas fa-search"></i> Buscar Producto
                        </button>
                        <button class="btn btn-secondary" id="btnLimpiarScanner">
                            <i class="fas fa-eraser"></i> Limpiar
                        </button>
                    </div>
                    
                    <div id="scannerResult" class="scanner-result">
                    </div>
                </div>
                
                <!-- Formulario de transferencia -->
                <div id="transferFormContainer" style="display: none;">
                    <hr>
                    <h3 style="margin-bottom: 20px;">Transferir Producto</h3>
                    <form id="transferForm">
                        <input type="hidden" id="transferProductId">
                        
                        <div class="form-group">
                            <label for="transferType">Tipo de Transferencia *</label>
                            <select id="transferType" required>
                                <option value="bodegaToTienda">De Bodega a Tienda</option>
                                <option value="tiendaToBodega">De Tienda a Bodega</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="transferQuantity">Cantidad a Transferir *</label>
                            <input type="number" id="transferQuantity" min="1" value="1" required>
                            <p id="availableStock" style="margin-top: 5px; font-size: 0.9rem; color: #666;"></p>
                        </div>
                        
                        <div class="form-group">
                            <button type="submit" class="btn btn-success" id="btnSubmitTransfer" style="width: 100%;">
                                <i class="fas fa-exchange-alt"></i> Realizar Transferencia
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Modal para importación rápida -->
        <div id="importModal" class="modal">
            <div class="modal-content modal-lg">
                <div class="modal-header">
                    <h2><i class="fas fa-file-import"></i> Importación Rápida</h2>
                    <span class="close-modal" id="closeImportModal">&times;</span>
                </div>
                <div class="form-group">
                    <p>Pega los datos en el formato: <strong>SKU | Producto | Cód. Barra | Existencia</strong></p>
                    <p>Ejemplo: <code>DPI001 | BACINICA PARA NIÑOS | DPI001 | 10</code></p>
                    <textarea id="importData" rows="10" placeholder="DPI001 | BACINICA PARA NIÑOS | DPI001 | 10&#10;DPI002 | JARRA 1LITRO SURTIDA C/TAPA | DPI002 | 15&#10;DPI003 | PRODUCTO EJEMPLO | DPI003 | 20"></textarea>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="importRapidoActualizarStock">
                    <label for="importRapidoActualizarStock">Actualizar stock existente (en lugar de sumar)</label>
                </div>
                
                <div class="form-group">
                    <label for="importRapidoProveedor">Proveedor (se aplicará a todos los productos)</label>
                    <select id="importRapidoProveedor">
                    </select>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-success" id="btnProcesarImportacion" style="width: 100%; display: none;">
                        <i class="fas fa-bolt"></i> Procesar Importación
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal para agregar/editar proveedor -->
        <div id="proveedorModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="proveedorModalTitle">Agregar Proveedor</h2>
                    <span class="close-modal" id="closeProveedorModal">&times;</span>
                </div>
                <form id="proveedorForm">
                    <div class="form-group">
                        <label for="proveedorCodigo">Código *</label>
                        <input type="text" id="proveedorCodigo" required placeholder="Ej: P00005">
                    </div>
                    
                    <div class="form-group">
                        <label for="proveedorNombre">Nombre del Proveedor *</label>
                        <input type="text" id="proveedorNombre" required placeholder="Ej: ROYALTEX S.A.">
                    </div>
                    
                    <div class="form-group">
                        <label for="proveedorDescripcion">Descripción</label>
                        <textarea id="proveedorDescripcion" rows="3" placeholder="Información adicional del proveedor..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="proveedorContacto">Contacto</label>
                        <input type="text" id="proveedorContacto" placeholder="Nombre de contacto">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="proveedorTelefono">Teléfono</label>
                            <input type="text" id="proveedorTelefono" placeholder="Teléfono">
                        </div>
                        
                        <div class="form-group">
                            <label for="proveedorEmail">Email</label>
                            <input type="email" id="proveedorEmail" placeholder="correo@ejemplo.com">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary" id="btnSubmitProveedor" style="width: 100%;">
                            <i class="fas fa-save"></i> Guardar Proveedor
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC5PwQQrY02yhICT4hl6nzZTEvA-CLgC2g",
            authDomain: "thogar-de74d.firebaseapp.com",
            projectId: "thogar-de74d",
            storageBucket: "thogar-de74d.firebasestorage.app",
            messagingSenderId: "605168322064",
            appId: "1:605168322064:web:e0d9a16c5e5bc230d9ac95"
        };

        // Inicializar Firebase
        let app, db;
        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase inicializado correctamente");
        } catch (error) {
            console.error("Error inicializando Firebase:", error);
        }

        // Estado de la aplicación
        let currentUser = null;
        let inventory = [];
        let historial = [];
        let proveedores = [];
        let editingProductId = null;
        let editingProveedorId = null;
        let nextId = 1;
        let nextHistorialId = 1;
        let nextProveedorId = 1;
        let currentSearchFilter = "all";
        let currentProveedorFilter = null;
        let isOnline = navigator.onLine;
        let isTransferring = false;
        
        // MODIFICACIÓN: Variables para ordenamiento
        let currentSortField = null;
        let currentSortDirection = 'asc';

        // Elementos del DOM
        const mainApp = document.getElementById('mainApp');
        const btnLogout = document.getElementById('btnLogout');
        const currentUsername = document.getElementById('currentUsername');
        const userRoleBadge = document.getElementById('userRoleBadge');
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        const proveedorTableBody = document.getElementById('proveedorTableBody');
        const proveedorSearchInput = document.getElementById('proveedorSearchInput');
        const proveedorSuggestions = document.getElementById('proveedorSuggestions');
        const proveedorSelected = document.getElementById('proveedorSelected');
        const proveedoresContainer = document.getElementById('proveedoresContainer');
        const productModal = document.getElementById('productModal');
        const scannerModal = document.getElementById('scannerModal');
        const importModal = document.getElementById('importModal');
        const proveedorModal = document.getElementById('proveedorModal');
        const closeModalBtn = document.getElementById('closeModal');
        const closeScannerModalBtn = document.getElementById('closeScannerModal');
        const closeImportModalBtn = document.getElementById('closeImportModal');
        const closeProveedorModalBtn = document.getElementById('closeProveedorModal');
        const productForm = document.getElementById('productForm');
        const proveedorForm = document.getElementById('proveedorForm');
        const transferForm = document.getElementById('transferForm');
        
        // NUEVOS BOTONES (modificados)
        const btnAddProductInventario = document.getElementById('btnAddProductInventario');
        const btnAddProductImportar = document.getElementById('btnAddProductImportar');
        const btnAddProveedor = document.getElementById('btnAddProveedor');
        const btnImportarRapidoImportar = document.getElementById('btnImportarRapidoImportar');
        const btnExportarProveedores = document.getElementById('btnExportarProveedores');
        const searchInput = document.getElementById('searchInput');
        const scannerInput = document.getElementById('scannerInput');
        const btnBuscarProducto = document.getElementById('btnBuscarProducto');
        const btnLimpiarScanner = document.getElementById('btnLimpiarScanner');
        const scannerResult = document.getElementById('scannerResult');
        const transferFormContainer = document.getElementById('transferFormContainer');
        const transferProductIdInput = document.getElementById('transferProductId');
        const transferTypeSelect = document.getElementById('transferType');
        const transferQuantityInput = document.getElementById('transferQuantity');
        const availableStockText = document.getElementById('availableStock');
        const historialContainer = document.getElementById('historialContainer');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const jsonFileInput = document.getElementById('jsonFileInput');
        const btnImportarJSON = document.getElementById('btnImportarJSON');
        const btnProcesarImportacion = document.getElementById('btnProcesarImportacion');
        const importDataTextarea = document.getElementById('importData');
        const importRapidoActualizarStock = document.getElementById('importRapidoActualizarStock');
        const importRapidoProveedor = document.getElementById('importRapidoProveedor');
        const exportFormatSelect = document.getElementById('exportFormat');
        const btnExportarJSON = document.getElementById('btnExportarJSON');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const connectionStatus = document.getElementById('connectionStatus');
        const actualizarStockData = document.getElementById('actualizarStockData');
        const actualizarSoloBodega = document.getElementById('actualizarSoloBodega');
        const btnProcesarActualizacion = document.getElementById('btnProcesarActualizacion');
        const actualizacionResultado = document.getElementById('actualizacionResultado');
        const importarActualizarStock = document.getElementById('importarActualizarStock');
        const importProveedor = document.getElementById('importProveedor');
        const btnExportarProveedorExcel = document.getElementById('btnExportarProveedorExcel');
        const loadingRow = document.getElementById('loadingRow');
        const btnSubmitProduct = document.getElementById('btnSubmitProduct');
        const btnSubmitTransfer = document.getElementById('btnSubmitTransfer');
        const btnSubmitProveedor = document.getElementById('btnSubmitProveedor');
        
        // MODIFICACIÓN: Nuevos elementos
        const btnRefresh = document.getElementById('btnRefresh');
        const btnRefreshProveedores = document.getElementById('btnRefreshProveedores');
        const btnRefreshGestionProveedores = document.getElementById('btnRefreshGestionProveedores');
        const btnRefreshActualizarStock = document.getElementById('btnRefreshActualizarStock');
        const btnRefreshHistorial = document.getElementById('btnRefreshHistorial');
        const btnRefreshImportar = document.getElementById('btnRefreshImportar');
        const btnRefreshInformacion = document.getElementById('btnRefreshInformacion');
        const proveedorProductSearch = document.getElementById('proveedorProductSearch');
        const tableHeaders = document.querySelectorAll('#inventarioTab th[data-sort]');
        const barcodesContainer = document.getElementById('barcodesContainer');
        const btnAddBarcode = document.getElementById('btnAddBarcode');
        const btnLimpiarHistorial = document.getElementById('btnLimpiarHistorial');

        // ==============================================
        // NUEVO: VERIFICAR AUTENTICACIÓN DESDE EL DASHBOARD
        // ==============================================

        // Función para verificar autenticación
        function checkAuth() {
            const session = localStorage.getItem('userSession') || sessionStorage.getItem('userSession');
            
            if (!session) {
                window.location.href = 'login.html';
                return null;
            }
            
            return JSON.parse(session);
        }

        // Función para recibir el rol desde el dashboard
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'USER_ROLE') {
                currentUser = {
                    username: event.data.username,
                    role: event.data.role
                };
                
                console.log('Rol recibido del dashboard:', currentUser);
                
                // Actualizar UI con el usuario
                currentUsername.textContent = currentUser.username;
                userRoleBadge.textContent = currentUser.role.toUpperCase();
                
                // Configurar permisos según el rol
                configurePermissionsByRole();
                
                // Cargar datos desde Firebase
                showLoadingSpinner();
                loadDataFromFirebase();
            }
        });

        // También podemos solicitar el rol si es necesario
        function requestUserRole() {
            window.parent.postMessage({
                type: 'REQUEST_USER_ROLE'
            }, '*');
        }

        // ==============================================
        // FUNCIONES DE MANEJO DE FECHAS EN FRONTEND
        // ==============================================

        // Función para obtener el timestamp actual
        function getCurrentTimestamp() {
            return Date.now();
        }

        // Función para formatear tiempo relativo (time ago)
        function formatTimeAgo(timestamp) {
            if (!timestamp) return "Nunca";
            
            const now = Date.now();
            const diff = now - timestamp;
            
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const weeks = Math.floor(days / 7);
            const months = Math.floor(days / 30);
            const years = Math.floor(days / 365);
            
            if (seconds < 60) {
                return "hace un momento";
            } else if (minutes < 60) {
                return minutes === 1 ? "hace 1 minuto" : `hace ${minutes} minutos`;
            } else if (hours < 24) {
                return hours === 1 ? "hace 1 hora" : `hace ${hours} horas`;
            } else if (days < 7) {
                return days === 1 ? "hace 1 día" : `hace ${days} días`;
            } else if (weeks < 4) {
                return weeks === 1 ? "hace 1 semana" : `hace ${weeks} semanas`;
            } else if (months < 12) {
                return months === 1 ? "hace 1 mes" : `hace ${months} meses`;
            } else {
                return years === 1 ? "hace 1 año" : `hace ${years} años`;
            }
        }

        // Función para formatear fecha completa (para exportaciones)
        function formatFullDate(timestamp) {
            if (!timestamp) return "Fecha no disponible";
            
            const date = new Date(timestamp);
            return date.toLocaleString('es-GT', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Función para obtener clase CSS según antigüedad
        function getTimeAgoClass(timestamp) {
            if (!timestamp) return "antiguo";
            
            const now = Date.now();
            const diff = now - timestamp;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return "reciente";
            if (days <= 7) return "reciente";
            if (days <= 30) return "";
            return "antiguo";
        }

        // Función para obtener clase CSS según nivel de stock
        function getStockLevelClass(stock) {
            if (stock <= 0) return 'critico';
            if (stock <= 0) return 'bajo';
            return '';
        }

        // ==============================================
        // FUNCIÓN PARA CONFIGURAR PERMISOS SEGÚN ROL
        // ==============================================

        function configurePermissionsByRole() {
            if (!currentUser) return;
            
            const isAdmin = currentUser.role === 'admin';
            
            console.log('Configurando permisos para rol:', currentUser.role);
            
            // Mostrar/ocultar botones según rol
            const adminButtons = [
                btnAddProductInventario,
                btnAddProductImportar,
                btnAddProveedor,
                btnImportarRapidoImportar,
                btnProcesarActualizacion,
                btnImportarJSON,
                btnProcesarImportacion,
                btnLimpiarHistorial
            ];
            
            adminButtons.forEach(btn => {
                if (btn) {
                    btn.style.display = isAdmin ? 'inline-flex' : 'none';
                }
            });
            
            // Actualizar acciones en las tablas
            setupTableActions();
        }

        // Función para actualizar acciones en las tablas según permisos
        function setupTableActions() {
            const isAdmin = currentUser && currentUser.role === 'admin';
            
            // No hacemos nada aquí porque las acciones se generan dinámicamente
            // en updateInventoryTable y updateProveedorTable
        }

        // ==============================================
        // FUNCIONES DE FIREBASE SIMPLIFICADAS
        // ==============================================

        // Cargar datos de Firebase SIN fechas
        async function loadDataFromFirebase() {
            try {
                if (!db) {
                    updateConnectionStatus(false);
                    console.log("Firebase no disponible");
                    showLoadingSpinner();
                    return false;
                }
                
                // Cargar productos - SIN procesar fechas
                const productsSnapshot = await db.collection('products').get();
                inventory = [];
                productsSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    inventory.push({
                        id: data.id || doc.id,
                        ...data
                    });
                });
                
                // Cargar historial - SIN procesar fechas
                const historySnapshot = await db.collection('historial').orderBy('timestamp', 'desc').limit(100).get();
                historial = [];
                historySnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    historial.push({
                        id: data.id || doc.id,
                        ...data
                    });
                });
                
                // Cargar proveedores - SIN procesar fechas
                const proveedoresSnapshot = await db.collection('proveedores').orderBy('codigo').get();
                proveedores = [];
                proveedoresSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    proveedores.push({
                        id: data.id || doc.id,
                        ...data
                    });
                });
                
                // Actualizar IDs
                if (inventory.length > 0) {
                    const ids = inventory.map(p => {
                        const id = parseInt(p.id);
                        return isNaN(id) ? 0 : id;
                    });
                    nextId = Math.max(...ids) + 1;
                }
                
                if (historial.length > 0) {
                    const histIds = historial.map(h => {
                        const id = parseInt(h.id);
                        return isNaN(id) ? 0 : id;
                    });
                    nextHistorialId = Math.max(...histIds) + 1;
                }
                
                if (proveedores.length > 0) {
                    const provIds = proveedores.map(p => {
                        const id = parseInt(p.id);
                        return isNaN(id) ? 0 : id;
                    });
                    nextProveedorId = Math.max(...provIds) + 1;
                }
                
                updateConnectionStatus(true);
                console.log('Datos cargados desde Firebase:', { 
                    productos: inventory.length, 
                    historial: historial.length,
                    proveedores: proveedores.length
                });
                
                updateInventoryTable();
                updateStats();
                updateHistorial();
                updateProveedorSelects();
                updateProveedoresList();
                setupTableActions();
                
                return true;
            } catch (error) {
                console.error('Error cargando datos de Firebase:', error);
                updateConnectionStatus(false);
                showLoadingSpinner();
                return false;
            }
        }

        // Guardar producto en Firebase
        async function saveProductToFirebase(productData, isUpdate = false) {
            try {
                if (!db) throw new Error("Firebase no disponible");
                
                const productRef = db.collection('products').doc(productData.id.toString());
                
                const dataToSave = {
                    id: productData.id,
                    sku: productData.sku,
                    barcode: productData.barcode,
                    barcodes: productData.barcodes || [],
                    name: productData.name,
                    proveedor: productData.proveedor,
                    bodega: productData.bodega,
                    tienda: productData.tienda,
                    lastTransfer: productData.lastTransfer || null
                };
                
                if (isUpdate) {
                    await productRef.update(dataToSave);
                } else {
                    await productRef.set(dataToSave);
                }
                
                console.log('Producto guardado en Firebase:', productData.id);
                return true;
            } catch (error) {
                console.error('Error guardando producto en Firebase:', error);
                throw error;
            }
        }

        // Guardar historial en Firebase con timestamp numérico
        async function saveHistoryToFirebase(historyItem) {
            try {
                if (!db) throw new Error("Firebase no disponible");
                
                const dataToSave = {
                    ...historyItem
                };
                
                await db.collection('historial').doc(historyItem.id.toString()).set(dataToSave);
                console.log('Historial guardado en Firebase:', historyItem.id);
                return true;
            } catch (error) {
                console.error('Error guardando historial en Firebase:', error);
                throw error;
            }
        }

        // Guardar proveedor en Firebase
        async function saveProveedorToFirebase(proveedorData, isUpdate = false) {
            try {
                if (!db) throw new Error("Firebase no disponible");
                
                const proveedorRef = db.collection('proveedores').doc(proveedorData.id.toString());
                
                const dataToSave = {
                    id: proveedorData.id,
                    codigo: proveedorData.codigo,
                    nombre: proveedorData.nombre,
                    descripcion: proveedorData.descripcion || '',
                    contacto: proveedorData.contacto || '',
                    telefono: proveedorData.telefono || '',
                    email: proveedorData.email || ''
                };
                
                if (isUpdate) {
                    await proveedorRef.update(dataToSave);
                } else {
                    await proveedorRef.set(dataToSave);
                }
                
                console.log('Proveedor guardado en Firebase:', proveedorData.id);
                return true;
            } catch (error) {
                console.error('Error guardando proveedor en Firebase:', error);
                throw error;
            }
        }

        // Eliminar producto de Firebase
        async function deleteProductFromFirebase(productId) {
            try {
                if (!db) throw new Error("Firebase no disponible");
                await db.collection('products').doc(productId.toString()).delete();
                console.log('Producto eliminado de Firebase:', productId);
                return true;
            } catch (error) {
                console.error('Error eliminando producto de Firebase:', error);
                throw error;
            }
        }

        // Eliminar proveedor de Firebase
        async function deleteProveedorFromFirebase(proveedorId) {
            try {
                if (!db) throw new Error("Firebase no disponible");
                await db.collection('proveedores').doc(proveedorId.toString()).delete();
                console.log('Proveedor eliminado de Firebase:', proveedorId);
                return true;
            } catch (error) {
                console.error('Error eliminando proveedor de Firebase:', error);
                throw error;
            }
        }

        // Limpiar historial de Firebase
        async function clearHistoryFromFirebase() {
            try {
                if (!db) throw new Error("Firebase no disponible");
                const batch = db.batch();
                const snapshot = await db.collection('historial').get();
                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                console.log('Historial limpiado de Firebase');
                return true;
            } catch (error) {
                console.error('Error limpiando historial de Firebase:', error);
                throw error;
            }
        }

        // ==============================================
        // FUNCIONES DE LA APLICACIÓN
        // ==============================================

        // Función para mostrar spinner de carga
        function showLoadingSpinner() {
            inventoryTableBody.innerHTML = `
                <tr id="loadingRow">
                    <td colspan="7" class="loading-spinner">
                        <div class="spinner-large"></div>
                    </td>
                </tr>
            `;
        }

        // Función para cerrar sesión
        function logout() {
            Swal.fire({
                title: '¿Cerrar sesión?',
                text: 'Se cerrará la sesión actual',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, cerrar',
                cancelButtonText: 'Cancelar',
                customClass: {
                    confirmButton: 'btn btn-danger',
                    cancelButton: 'btn btn-secondary'
                },
                buttonsStyling: false
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('userSession');
                    sessionStorage.removeItem('userSession');
                    localStorage.removeItem('userRole');
                    window.location.href = 'login.html';
                }
            });
        }

        // Función para actualizar estado de conexión
        function updateConnectionStatus(online) {
            isOnline = online;
            if (connectionStatus) {
                if (online) {
                    connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> Conectado';
                    connectionStatus.style.color = 'var(--success)';
                } else {
                    connectionStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> Sin conexión';
                    connectionStatus.style.color = 'var(--warning)';
                }
            }
        }

        // Función para ordenar por campo
        function sortByField(field) {
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }
            
            updateInventoryTable(searchInput.value);
            updateSortHeaders();
        }

        // Función para actualizar encabezados de ordenamiento
        function updateSortHeaders() {
            tableHeaders.forEach(header => {
                const field = header.getAttribute('data-sort');
                const icon = header.querySelector('i');
                if (icon) {
                    if (currentSortField === field) {
                        icon.className = currentSortDirection === 'asc' ? 
                            'fas fa-sort-up' : 'fas fa-sort-down';
                    } else {
                        icon.className = 'fas fa-sort';
                    }
                }
            });
        }

        // Función para ordenar productos
        function sortProducts(products) {
            if (!currentSortField) {
                return products;
            }
            
            let sortedProducts = [...products];
            
            sortedProducts.sort((a, b) => {
                let aValue, bValue;
                
                switch(currentSortField) {
                    case 'sku':
                        aValue = a.sku;
                        bValue = b.sku;
                        break;
                    case 'name':
                        aValue = a.name;
                        bValue = b.name;
                        break;
                    case 'barcode':
                        aValue = a.barcode;
                        bValue = b.barcode;
                        break;
                    case 'proveedor':
                        aValue = a.proveedor;
                        bValue = b.proveedor;
                        break;
                    case 'stock':
                        aValue = a.bodega;
                        bValue = b.bodega;
                        break;
                    case 'envio':
                        aValue = a.lastTransfer || 0;
                        bValue = b.lastTransfer || 0;
                        break;
                    default:
                        return 0;
                }
                
                if (typeof aValue === 'string' && typeof bValue === 'string') {
                    return currentSortDirection === 'asc' ? 
                        aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                } else {
                    return currentSortDirection === 'asc' ? 
                        aValue - bValue : bValue - aValue;
                }
            });
            
            return sortedProducts;
        }

        // Función para agregar campo de código de barras
        function addBarcodeField(value = '') {
            const barcodeItem = document.createElement('div');
            barcodeItem.className = 'barcode-item';
            barcodeItem.innerHTML = `
                <input type="text" class="additional-barcode" placeholder="Código de barras adicional" value="${value}">
                <div class="barcode-actions">
                    <button type="button" class="btn btn-small btn-danger remove-barcode">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            barcodesContainer.appendChild(barcodeItem);
            
            // Configurar evento para eliminar
            const removeBtn = barcodeItem.querySelector('.remove-barcode');
            removeBtn.addEventListener('click', function() {
                barcodeItem.remove();
            });
        }

        // Función para leer archivo como JSON
        function readFileAsJSON(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        resolve(data);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // Función para mostrar resultados de actualización
        function mostrarResultadosActualizacion(resultados, actualizados, noEncontrados) {
            actualizacionResultado.innerHTML = '';
            actualizacionResultado.style.display = 'block';
            
            let html = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="margin-bottom: 15px; color: var(--primary-blue);">
                        <i class="fas fa-clipboard-check"></i> Resultados de la Actualización
                    </h4>
                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div style="flex: 1; text-align: center; padding: 10px; background: #e8f5e9; border-radius: 6px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">${actualizados}</div>
                            <div style="font-size: 0.9rem; color: #666;">Actualizados</div>
                        </div>
                        <div style="flex: 1; text-align: center; padding: 10px; background: #fff3e0; border-radius: 6px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning);">${noEncontrados}</div>
                            <div style="font-size: 0.9rem; color: #666;">No encontrados</div>
                        </div>
                    </div>
            `;
            
            if (resultados.length > 0) {
                html += `<div style="max-height: 300px; overflow-y: auto;">`;
                resultados.forEach((resultado, index) => {
                    if (resultado.error) {
                        html += `
                            <div style="padding: 10px; margin-bottom: 8px; background: #ffebee; border-left: 4px solid var(--danger); border-radius: 0 4px 4px 0;">
                                <div style="font-weight: bold; color: var(--danger);">${resultado.sku}</div>
                                <div style="font-size: 0.9rem; color: #666;">${resultado.error}</div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="padding: 10px; margin-bottom: 8px; background: #f9f9f9; border-left: 4px solid var(--success); border-radius: 0 4px 4px 0;">
                                <div style="font-weight: bold; color: var(--primary-blue);">${resultado.sku} - ${resultado.nombre}</div>
                                <div style="display: flex; gap: 15px; margin-top: 5px; font-size: 0.9rem;">
                                    <div>
                                        <span style="color: #666;">Bodega:</span>
                                        <span style="margin-left: 5px; font-weight: bold; ${resultado.viejoBodega !== resultado.nuevoBodega ? 'color: var(--secondary-blue);' : 'color: #666;'}">
                                            ${resultado.viejoBodega} → ${resultado.nuevoBodega}
                                        </span>
                                    </div>
                                    <div>
                                        <span style="color: #666;">Tienda:</span>
                                        <span style="margin-left: 5px; font-weight: bold; ${resultado.viejoTienda !== resultado.nuevoTienda ? 'color: var(--secondary-blue);' : 'color: #666;'}">
                                            ${resultado.viejoTienda} → ${resultado.nuevoTienda}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                html += `</div>`;
            }
            
            html += `</div>`;
            actualizacionResultado.innerHTML = html;
        }

        // Función para exportar proveedores
        function exportarProveedores() {
            let contenido = 'Código\tNombre\tDescripción\tContacto\tTeléfono\tEmail\n';
            proveedores.forEach(proveedor => {
                contenido += `${proveedor.codigo}\t${proveedor.nombre}\t${proveedor.descripcion || ''}\t${proveedor.contacto || ''}\t${proveedor.telefono || ''}\t${proveedor.email || ''}\n`;
            });
            
            const blob = new Blob([contenido], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `proveedores_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            Swal.fire({
                title: 'Proveedores exportados',
                text: 'La lista de proveedores se ha exportado correctamente',
                icon: 'success',
                confirmButtonText: 'OK',
                customClass: {
                    confirmButton: 'btn btn-success'
                },
                buttonsStyling: false
            });
        }

        // Función para exportar inventario por proveedor a Excel
        function exportarInventarioPorProveedorExcel() {
            if (!currentProveedorFilter) {
                Swal.fire({
                    title: 'Selecciona un proveedor',
                    text: 'Primero debes seleccionar un proveedor para exportar su inventario',
                    icon: 'info',
                    confirmButtonText: 'Entendido',
                    customClass: {
                        confirmButton: 'btn btn-info'
                    },
                    buttonsStyling: false
                });
                return;
            }
            
            const productosProveedor = inventory.filter(product => product.proveedor === currentProveedorFilter);
            
            if (productosProveedor.length === 0) {
                Swal.fire({
                    title: 'No hay productos',
                    text: `El proveedor ${currentProveedorFilter} no tiene productos en el inventario`,
                    icon: 'warning',
                    confirmButtonText: 'Entendido',
                    customClass: {
                        confirmButton: 'btn btn-warning'
                    },
                    buttonsStyling: false
                });
                return;
            }
            
            const datos = [
                ['PROVEEDOR:', currentProveedorFilter],
                ['FECHA EXPORTACIÓN:', new Date().toISOString().split('T')[0]],
                ['TOTAL PRODUCTOS:', productosProveedor.length],
                [],
                ['SKU', 'PRODUCTO', 'CÓDIGO DE BARRAS', 'STOCK BODEGA', 'STOCK TIENDA', 'TOTAL', 'ÚLTIMO ENVÍO']
            ];
            
            let totalBodega = 0;
            let totalTienda = 0;
            let totalGeneral = 0;
            
            productosProveedor.forEach(producto => {
                const totalProducto = producto.bodega + producto.tienda;
                totalBodega += producto.bodega;
                totalTienda += producto.tienda;
                totalGeneral += totalProducto;
                
                const ultimoEnvio = producto.lastTransfer ? 
                    formatFullDate(producto.lastTransfer) : 'Nunca';
                
                datos.push([
                    producto.sku,
                    producto.name,
                    producto.barcode,
                    producto.bodega,
                    producto.tienda,
                    totalProducto,
                    ultimoEnvio
                ]);
            });
            
            datos.push([]);
            datos.push(['TOTALES:', '', '', totalBodega, totalTienda, totalGeneral, '']);
            
            const ws = XLSX.utils.aoa_to_sheet(datos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventario");
            
            const proveedorNombre = currentProveedorFilter.replace(/[^\w\s]/gi, '').replace(/\s+/g, '_');
            const filename = `inventario_${proveedorNombre}_${new Date().toISOString().split('T')[0]}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            
            agregarAlHistorial(
                'exportacion',
                null,
                productosProveedor.length,
                `proveedor_${currentProveedorFilter}`,
                'excel'
            );
            
            Swal.fire({
                title: 'Exportación exitosa',
                html: `Se exportaron <strong>${productosProveedor.length}</strong> productos del proveedor <strong>${currentProveedorFilter}</strong> a Excel<br>
                      <strong>Stock total:</strong> ${totalGeneral} unidades`,
                icon: 'success',
                confirmButtonText: 'OK',
                customClass: {
                    confirmButton: 'btn btn-success'
                },
                buttonsStyling: false
            });
        }

        // Función para exportar a Excel
        function exportarAExcel() {
            const datos = [
                ['INVENTARIO COMPLETO'],
                ['FECHA EXPORTACIÓN:', new Date().toISOString().split('T')[0]],
                ['TOTAL PRODUCTOS:', inventory.length],
                [],
                ['SKU', 'PRODUCTO', 'CÓDIGO DE BARRAS', 'PROVEEDOR', 'STOCK BODEGA', 'STOCK TIENDA', 'TOTAL', 'ÚLTIMO ENVÍO']
            ];
            
            let totalBodega = 0;
            let totalTienda = 0;
            let totalGeneral = 0;
            
            inventory.forEach(producto => {
                const totalProducto = producto.bodega + producto.tienda;
                totalBodega += producto.bodega;
                totalTienda += producto.tienda;
                totalGeneral += totalProducto;
                
                const ultimoEnvio = producto.lastTransfer ? 
                    formatFullDate(producto.lastTransfer) : 'Nunca';
                
                datos.push([
                    producto.sku,
                    producto.name,
                    producto.barcode,
                    producto.proveedor,
                    producto.bodega,
                    producto.tienda,
                    totalProducto,
                    ultimoEnvio
                ]);
            });
            
            datos.push([]);
            datos.push(['TOTALES:', '', '', '', totalBodega, totalTienda, totalGeneral, '']);
            
            const ws = XLSX.utils.aoa_to_sheet(datos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventario");
            
            const filename = `inventario_completo_${new Date().toISOString().split('T')[0]}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            
            agregarAlHistorial(
                'exportacion',
                null,
                inventory.length,
                'sistema',
                'excel'
            );
            
            Swal.fire({
                title: 'Exportación exitosa',
                html: `Se exportaron <strong>${inventory.length}</strong> productos a Excel<br>
                      <strong>Stock total:</strong> ${totalGeneral} unidades`,
                icon: 'success',
                confirmButtonText: 'OK',
                customClass: {
                    confirmButton: 'btn btn-success'
                },
                buttonsStyling: false
            });
        }

        // Obtener lista única de proveedores
        function getProveedoresUnicos() {
            const proveedoresDeProductos = inventory.map(product => product.proveedor);
            const proveedoresDeLista = proveedores.map(proveedor => `${proveedor.codigo} - ${proveedor.nombre}`);
            const todosProveedores = [...new Set([...proveedoresDeProductos, ...proveedoresDeLista])];
            return todosProveedores.sort();
        }

        // Obtener último envío formateado con tiempo relativo
        function getUltimoEnvioFormateado(producto) {
            if (!producto.lastTransfer) return "Nunca";
            return formatTimeAgo(producto.lastTransfer);
        }

        // Obtener clase CSS según antigüedad
        function getClaseUltimoEnvio(producto) {
            return getTimeAgoClass(producto.lastTransfer);
        }

        // Actualizar selects de proveedores en formularios
        function updateProveedorSelects() {
            const productProveedorSelect = document.getElementById('productProveedor');
            const importProveedorSelect = document.getElementById('importProveedor');
            const importRapidoProveedorSelect = document.getElementById('importRapidoProveedor');
            
            productProveedorSelect.innerHTML = '<option value="">Seleccionar proveedor</option>';
            importProveedorSelect.innerHTML = '<option value="">Seleccionar proveedor</option>';
            importRapidoProveedorSelect.innerHTML = '<option value="">Seleccionar proveedor</option>';
            
            const nuevaOpcion = document.createElement('option');
            nuevaOpcion.value = "nuevo";
            nuevaOpcion.textContent = "[+] Agregar nuevo proveedor";
            productProveedorSelect.appendChild(nuevaOpcion.cloneNode(true));
            importProveedorSelect.appendChild(nuevaOpcion.cloneNode(true));
            importRapidoProveedorSelect.appendChild(nuevaOpcion);
            
            const proveedoresList = proveedores.map(p => `${p.codigo} - ${p.nombre}`);
            proveedoresList.forEach(proveedor => {
                const option = document.createElement('option');
                option.value = proveedor;
                option.textContent = proveedor;
                productProveedorSelect.appendChild(option.cloneNode(true));
                importProveedorSelect.appendChild(option.cloneNode(true));
                importRapidoProveedorSelect.appendChild(option.cloneNode(true));
            });
            
            const proveedorSelects = [productProveedorSelect, importProveedorSelect, importRapidoProveedorSelect];
            proveedorSelects.forEach(select => {
                select.addEventListener('change', function() {
                    if (this.value === "nuevo") {
                        if (currentUser && currentUser.role !== 'admin') {
                            Swal.fire({
                                title: 'Acceso denegado',
                                text: 'No tienes permisos para agregar proveedores',
                                icon: 'warning',
                                confirmButtonText: 'Entendido',
                                customClass: {
                                    confirmButton: 'btn btn-warning'
                                },
                                buttonsStyling: false
                            });
                            this.selectedIndex = 0;
                            return;
                        }
                        
                        Swal.fire({
                            title: 'Nuevo Proveedor',
                            input: 'text',
                            inputLabel: 'Ingrese el nombre del nuevo proveedor',
                            inputPlaceholder: 'Ej: P00005 - ROYALTEX S.A.',
                            showCancelButton: true,
                            confirmButtonText: 'Agregar',
                            cancelButtonText: 'Cancelar',
                            icon: 'question',
                            customClass: {
                                confirmButton: 'btn btn-success',
                                cancelButton: 'btn btn-danger'
                            },
                            buttonsStyling: false
                        }).then((result) => {
                            if (result.isConfirmed && result.value.trim()) {
                                const nuevoProveedor = result.value.trim();
                                const option = document.createElement('option');
                                option.value = nuevoProveedor;
                                option.textContent = nuevoProveedor;
                                option.selected = true;
                                
                                proveedorSelects.forEach(sel => {
                                    sel.insertBefore(option.cloneNode(true), sel.lastChild);
                                });
                            } else {
                                this.selectedIndex = 0;
                            }
                        });
                    }
                });
            });
        }

        // Actualizar lista de proveedores en la pestaña de gestión
        function updateProveedoresList() {
            proveedoresContainer.innerHTML = '';
            
            if (proveedores.length === 0) {
                proveedoresContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-truck" style="font-size: 3rem; margin-bottom: 15px; display: block; color: #ccc;"></i>
                        No hay proveedores registrados. Agrega tu primer proveedor.
                    </div>
                `;
                return;
            }
            
            proveedores.forEach(proveedor => {
                const card = document.createElement('div');
                card.className = 'proveedor-card';
                
                const productosProveedor = inventory.filter(p => p.proveedor === `${proveedor.codigo} - ${proveedor.nombre}`);
                const count = productosProveedor.length;
                
                const isAdmin = currentUser && currentUser.role === 'admin';
                const actionsHtml = isAdmin ? `
                    <div class="proveedor-actions">
                        <button class="action-btn edit-btn" onclick="editProveedor(${proveedor.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteProveedor(${proveedor.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                ` : '';
                
                card.innerHTML = `
                    <div class="proveedor-info">
                        <div class="proveedor-info-header">
                            <h4>${proveedor.codigo} - ${proveedor.nombre}</h4>
                            <span class="proveedor-count-badge">${count} productos</span>
                        </div>
                        ${proveedor.descripcion ? `<p>${proveedor.descripcion}</p>` : ''}
                        <div style="display: flex; gap: 15px; margin-top: 10px; font-size: 0.9rem;">
                            ${proveedor.contacto ? `<div><i class="fas fa-user"></i> ${proveedor.contacto}</div>` : ''}
                            ${proveedor.telefono ? `<div><i class="fas fa-phone"></i> ${proveedor.telefono}</div>` : ''}
                            ${proveedor.email ? `<div><i class="fas fa-envelope"></i> ${proveedor.email}</div>` : ''}
                        </div>
                    </div>
                    ${actionsHtml}
                `;
                proveedoresContainer.appendChild(card);
            });
        }

        // Actualizar la tabla de inventario con filtro
        function updateInventoryTable(searchTerm = '') {
            inventoryTableBody.innerHTML = '';
            
            if (inventory.length === 0) {
                inventoryTableBody.innerHTML = `
                    <tr id="loadingRow">
                        <td colspan="7" class="loading-spinner">
                            <div class="spinner-large"></div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Filtrar y ordenar productos
            const filteredProducts = inventory.filter(product => {
                if (!searchTerm) return true;
                const term = searchTerm.toLowerCase();
                return product.sku.toLowerCase().includes(term) ||
                       product.name.toLowerCase().includes(term) ||
                       product.barcode.toLowerCase().includes(term) ||
                       (product.barcodes && Array.isArray(product.barcodes) && 
                        product.barcodes.some(bc => bc.toLowerCase().includes(term))) ||
                       product.proveedor.toLowerCase().includes(term);
            });
            
            // Aplicar ordenamiento
            const sortedProducts = sortProducts(filteredProducts);
            
            sortedProducts.forEach(product => {
                const ultimoEnvio = getUltimoEnvioFormateado(product);
                const claseEnvio = getClaseUltimoEnvio(product);
                const stockClass = getStockLevelClass(product.bodega);
                
                const isAdmin = currentUser && currentUser.role === 'admin';
                const actionsHtml = isAdmin ? `
                    <td class="actions-cell">
                        <button class="action-btn edit-btn" onclick="editProduct(${product.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn transfer-btn" onclick="openTransferScanner(${product.id})">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteProduct(${product.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                ` : `
                    <td class="actions-cell">
                        <button class="action-btn transfer-btn" onclick="openTransferScanner(${product.id})">
                            <i class="fas fa-exchange-alt"></i> Transferir
                        </button>
                    </td>
                `;
                
                // Mostrar código de barras principal
                const barcodeDisplay = product.barcode || '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${product.sku}</strong></td>
                    <td>${product.name}</td>
                    <td>${barcodeDisplay}</td>
                    <td>${product.proveedor}</td>
                    <td class="stock-cell ${stockClass}">${product.bodega}</td>
                    <td><span class="ultimo-envio ${claseEnvio}">${ultimoEnvio}</span></td>
                    ${actionsHtml}
                `;
                inventoryTableBody.appendChild(row);
            });
            
            if (filteredProducts.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-box-open" style="font-size: 2rem; margin-bottom: 10px; display: block; color: #ccc;"></i>
                        ${inventory.length === 0 ? 'No hay productos en el inventario. Agrega tu primer producto.' : 'No se encontraron productos que coincidan'}
                    </td>
                `;
                inventoryTableBody.appendChild(row);
            }
        }

        // Actualizar tabla de proveedores
        function updateProveedorTable() {
            proveedorTableBody.innerHTML = '';
            
            if (inventory.length === 0) {
                proveedorTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="loading-spinner">
                            <div class="spinner-large"></div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let filteredProducts;
            if (!currentProveedorFilter) {
                filteredProducts = [...inventory];
                proveedorSelected.textContent = "Mostrando todos los proveedores";
            } else {
                filteredProducts = inventory.filter(product => product.proveedor === currentProveedorFilter);
                const productCount = filteredProducts.length;
                proveedorSelected.innerHTML = `
                    <div class="proveedor-info-header">
                        <span>Mostrando: ${currentProveedorFilter}</span>
                        <span class="proveedor-count-badge">${productCount} productos</span>
                    </div>
                `;
            }
            
            // Aplicar búsqueda en pestaña proveedores
            const searchTerm = proveedorProductSearch.value.toLowerCase().trim();
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(product => {
                    return product.sku.toLowerCase().includes(searchTerm) ||
                           product.name.toLowerCase().includes(searchTerm) ||
                           product.barcode.toLowerCase().includes(searchTerm) ||
                           (product.barcodes && Array.isArray(product.barcodes) && 
                            product.barcodes.some(bc => bc.toLowerCase().includes(searchTerm))) ||
                           product.proveedor.toLowerCase().includes(searchTerm);
                });
            }
            
            filteredProducts.forEach(product => {
                const ultimoEnvio = getUltimoEnvioFormateado(product);
                const claseEnvio = getClaseUltimoEnvio(product);
                const stockClass = getStockLevelClass(product.bodega);
                
                const isAdmin = currentUser && currentUser.role === 'admin';
                const actionsHtml = isAdmin ? `
                    <td class="actions-cell">
                        <button class="action-btn edit-btn" onclick="editProduct(${product.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn transfer-btn" onclick="openTransferScanner(${product.id})">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteProduct(${product.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                ` : `
                    <td class="actions-cell">
                        <button class="action-btn transfer-btn" onclick="openTransferScanner(${product.id})">
                            <i class="fas fa-exchange-alt"></i> Transferir
                        </button>
                    </td>
                `;
                
                const barcodeDisplay = product.barcode || '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${product.sku}</strong></td>
                    <td>${product.name}</td>
                    <td>${barcodeDisplay}</td>
                    <td>${product.proveedor}</td>
                    <td class="stock-cell ${stockClass}">${product.bodega}</td>
                    <td><span class="ultimo-envio ${claseEnvio}">${ultimoEnvio}</span></td>
                    ${actionsHtml}
                `;
                proveedorTableBody.appendChild(row);
            });
            
            if (filteredProducts.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-box-open" style="font-size: 2rem; margin-bottom: 10px; display: block; color: #ccc;"></i>
                        ${!currentProveedorFilter ? 'No hay productos en el inventario' : `No hay productos del proveedor: ${currentProveedorFilter}`}
                        ${searchTerm ? ` que coincidan con "${searchTerm}"` : ''}
                    </td>
                `;
                proveedorTableBody.appendChild(row);
            }
        }

        // Actualizar estadísticas
        function updateStats() {
            const totalBodega = inventory.reduce((sum, product) => sum + product.bodega, 0);
            const totalTienda = inventory.reduce((sum, product) => sum + product.tienda, 0);
            const totalProveedores = getProveedoresUnicos().length;
            
            document.getElementById('totalBodega').textContent = totalBodega;
            document.getElementById('totalTienda').textContent = totalTienda;
            document.getElementById('totalProveedores').textContent = totalProveedores;
            document.getElementById('totalMovimientos').textContent = historial.length;
        }

        // Actualizar historial de movimientos
        function updateHistorial() {
            historialContainer.innerHTML = '';
            
            const historialOrdenado = [...historial].sort((a, b) => {
                return (b.timestamp || 0) - (a.timestamp || 0);
            });
            
            if (historialOrdenado.length === 0) {
                historialContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><i class="fas fa-history" style="font-size: 3rem; margin-bottom: 15px; display: block; color: #ccc;"></i>No hay movimientos registrados</div>';
                return;
            }
            
            historialOrdenado.forEach(movimiento => {
                const item = document.createElement('div');
                item.className = `historial-item`;
                
                let tipoBadge = '';
                let icon = '';
                let detalles = '';
                let tipoClase = '';
                
                if (movimiento.tipo === 'transferencia') {
                    tipoBadge = 'TRANSFERENCIA';
                    icon = '<i class="fas fa-exchange-alt"></i>';
                    detalles = `De <strong>${movimiento.origen}</strong> a <strong>${movimiento.destino}</strong>`;
                    tipoClase = 'tipo-transferencia';
                } else if (movimiento.tipo === 'importacion') {
                    tipoBadge = 'IMPORTACIÓN';
                    icon = '<i class="fas fa-file-import"></i>';
                    detalles = `Origen: <strong>${movimiento.origen}</strong>`;
                    tipoClase = 'tipo-importacion';
                } else if (movimiento.tipo === 'actualizacion_stock') {
                    tipoBadge = 'ACTUALIZACIÓN';
                    icon = '<i class="fas fa-sync-alt"></i>';
                    detalles = `Tipo: <strong>${movimiento.origen}</strong>`;
                    tipoClase = 'tipo-actualizacion';
                } else if (movimiento.tipo === 'exportacion') {
                    tipoBadge = 'EXPORTACIÓN';
                    icon = '<i class="fas fa-file-export"></i>';
                    detalles = `Formato: <strong>${movimiento.origen}</strong>`;
                    tipoClase = 'tipo-importacion';
                } else if (movimiento.tipo === 'eliminacion') {
                    tipoBadge = 'ELIMINACIÓN';
                    icon = '<i class="fas fa-trash"></i>';
                    detalles = `De: <strong>${movimiento.origen}</strong>`;
                    tipoClase = 'tipo-transferencia';
                } else {
                    tipoBadge = 'SISTEMA';
                    icon = '<i class="fas fa-cog"></i>';
                    detalles = `Tipo: <strong>${movimiento.origen}</strong>`;
                    tipoClase = 'tipo-importacion';
                }
                
                const tiempoRelativo = movimiento.timestamp ? formatTimeAgo(movimiento.timestamp) : 'Fecha no disponible';
                
                item.innerHTML = `
                    <div class="historial-header">
                        <div>
                            <span class="historial-fecha">${tiempoRelativo}</span>
                            <span class="historial-tipo ${tipoClase}">${tipoBadge}</span>
                        </div>
                        <div style="font-weight: bold; color: var(--primary-blue);">
                            ${icon} ${movimiento.cantidad} unidades
                        </div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>${movimiento.producto}</strong> ${movimiento.sku !== 'N/A' ? '(SKU: ' + movimiento.sku + ')' : ''}
                    </div>
                    <div style="margin-bottom: 10px;">
                        ${detalles}
                    </div>
                    <div style="color: #666; font-size: 0.9rem;">
                        <i class="fas fa-user"></i> ${movimiento.usuario}
                    </div>
                `;
                
                historialContainer.appendChild(item);
            });
        }

        // Buscar producto por SKU, nombre o código de barras
        function buscarProducto(termino) {
            if (!termino) return null;
            
            const term = termino.toLowerCase().trim();
            
            return inventory.find(product => 
                product.sku.toLowerCase() === term ||
                product.barcode.toLowerCase() === term ||
                (product.barcodes && Array.isArray(product.barcodes) && 
                 product.barcodes.some(bc => bc.toLowerCase() === term)) ||
                product.sku.toLowerCase().includes(term) ||
                product.name.toLowerCase().includes(term) ||
                product.barcode.toLowerCase().includes(term) ||
                (product.barcodes && Array.isArray(product.barcodes) && 
                 product.barcodes.some(bc => bc.toLowerCase().includes(term)))
            );
        }

        // Mostrar resultado de búsqueda en modal de scanner
        function mostrarResultadoBusqueda(producto) {
            if (!producto) {
                scannerResult.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--danger);">
                        <i class="fas fa-times-circle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h4>Producto no encontrado</h4>
                        <p>No se encontró ningún producto con el código: ${scannerInput.value}</p>
                        <p>Intenta con el SKU, nombre o código de barras.</p>
                    </div>
                `;
                scannerResult.classList.add('active');
                transferFormContainer.style.display = 'none';
                return;
            }
            
            // Mostrar códigos de barras adicionales
            let barcodesHtml = '';
            if (producto.barcodes && Array.isArray(producto.barcodes) && producto.barcodes.length > 0) {
                barcodesHtml = `<p><strong>Códigos de Barras:</strong> ${producto.barcodes.join(', ')}</p>`;
            }
            
            scannerResult.innerHTML = `
                <div class="product-info">
                    <div class="product-icon">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="product-details">
                        <h4>${producto.name}</h4>
                        <p><strong>SKU:</strong> ${producto.sku} | <strong>Código Principal:</strong> ${producto.barcode}</p>
                        ${barcodesHtml}
                        <p><strong>Proveedor:</strong> ${producto.proveedor}</p>
                    </div>
                </div>
                
                <div class="stock-info">
                    <div class="stock-item">
                        <div class="label">Stock Bodega</div>
                        <div class="value">${producto.bodega}</div>
                    </div>
                    <div class="stock-item">
                        <div class="label">Stock Tienda</div>
                        <div class="value">${producto.tienda}</div>
                    </div>
                    <div class="stock-item">
                        <div class="label">Último Envío</div>
                        <div class="value">${getUltimoEnvioFormateado(producto)}</div>
                    </div>
                </div>
            `;
            
            scannerResult.classList.add('active');
            transferProductIdInput.value = producto.id;
            transferQuantityInput.value = 1;
            transferTypeSelect.value = 'bodegaToTienda';
            updateAvailableStockForProduct(producto.id);
            transferFormContainer.style.display = 'block';
        }

        // Actualizar stock disponible para producto específico
        function updateAvailableStockForProduct(productId) {
            const producto = inventory.find(p => p.id === productId);
            if (!producto) return;
            
            const transferType = transferTypeSelect.value;
            
            if (transferType === 'bodegaToTienda') {
                availableStockText.textContent = `Disponible en bodega: ${producto.bodega} unidades`;
                availableStockText.style.color = 'var(--primary-blue)';
                transferQuantityInput.max = producto.bodega;
            } else {
                availableStockText.textContent = `Disponible en tienda: ${producto.tienda} unidades`;
                availableStockText.style.color = 'var(--success)';
                transferQuantityInput.max = producto.tienda;
            }
        }

        // Agregar registro al historial con timestamp numérico
        async function agregarAlHistorial(tipo, productoId, cantidad, origen, destino) {
            const producto = inventory.find(p => p.id === productoId);
            
            const nuevoRegistro = {
                id: nextHistorialId++,
                timestamp: getCurrentTimestamp(),
                tipo: tipo,
                producto: producto ? producto.name : 'Importación múltiple',
                sku: producto ? producto.sku : 'N/A',
                cantidad: cantidad,
                origen: origen,
                destino: destino,
                usuario: currentUser ? currentUser.username : 'desconocido'
            };
            
            try {
                if (isOnline && db) {
                    await saveHistoryToFirebase(nuevoRegistro);
                }
                
                historial.unshift(nuevoRegistro);
                updateHistorial();
                updateStats();
                
                return true;
            } catch (error) {
                console.error('Error guardando historial:', error);
                historial.unshift(nuevoRegistro);
                updateHistorial();
                updateStats();
                return false;
            }
        }

        // Función para abrir modal de scanner
        function openTransferScanner(productId = null) {
            scannerInput.value = '';
            scannerResult.classList.remove('active');
            transferFormContainer.style.display = 'none';
            
            if (productId) {
                const producto = inventory.find(p => p.id === productId);
                if (producto) {
                    scannerInput.value = producto.sku;
                    mostrarResultadoBusqueda(producto);
                }
            }
            
            scannerModal.style.display = 'flex';
            scannerInput.focus();
        }

        // Función para editar producto (solo admin)
        function editProduct(id) {
            if (currentUser.role !== 'admin') {
                Swal.fire({
                    title: 'Acceso denegado',
                    text: 'No tienes permisos para editar productos',
                    icon: 'warning',
                    confirmButtonText: 'Entendido',
                    customClass: {
                        confirmButton: 'btn btn-warning'
                    },
                    buttonsStyling: false
                });
                return;
            }
            
            const product = inventory.find(p => p.id === id);
            if (!product) return;
            
            editingProductId = id;
            document.getElementById('modalTitle').textContent = 'Editar Producto';
            document.getElementById('productSKU').value = product.sku;
            document.getElementById('productBarCode').value = product.barcode;
            document.getElementById('productName').value = product.name;
            
            const proveedorSelect = document.getElementById('productProveedor');
            const options = Array.from(proveedorSelect.options);
            const index = options.findIndex(option => option.value === product.proveedor);
            if (index !== -1) {
                proveedorSelect.selectedIndex = index;
            }
            
            document.getElementById('stockBodega').value = product.bodega;
            document.getElementById('stockTienda').value = product.tienda;
            
            // Cargar códigos de barras adicionales
            barcodesContainer.innerHTML = '';
            if (product.barcodes && Array.isArray(product.barcodes)) {
                product.barcodes.forEach((barcode, index) => {
                    if (index > 0 || barcode !== product.barcode) {
                        addBarcodeField(barcode);
                    }
                });
            }
            
            productModal.style.display = 'flex';
        }

        // Función para editar proveedor (solo admin)
        function editProveedor(id) {
            if (currentUser.role !== 'admin') {
                Swal.fire({
                    title: 'Acceso denegado',
                    text: 'No tienes permisos para editar proveedores',
                    icon: 'warning',
                    confirmButtonText: 'Entendido',
                    customClass: {
                        confirmButton: 'btn btn-warning'
                    },
                    buttonsStyling: false
                });
                return;
            }
            
            const proveedor = proveedores.find(p => p.id === id);
            if (!proveedor) return;
            
            editingProveedorId = id;
            document.getElementById('proveedorModalTitle').textContent = 'Editar Proveedor';
            document.getElementById('proveedorCodigo').value = proveedor.codigo;
            document.getElementById('proveedorNombre').value = proveedor.nombre;
            document.getElementById('proveedorDescripcion').value = proveedor.descripcion || '';
            document.getElementById('proveedorContacto').value = proveedor.contacto || '';
            document.getElementById('proveedorTelefono').value = proveedor.telefono || '';
            document.getElementById('proveedorEmail').value = proveedor.email || '';
            proveedorModal.style.display = 'flex';
        }

        // Función para eliminar producto (solo admin)
        async function deleteProduct(id) {
            if (currentUser.role !== 'admin') {
                Swal.fire({
                    title: 'Acceso denegado',
                    text: 'No tienes permisos para eliminar productos',
                    icon: 'warning',
                    confirmButtonText: 'Entendido',
                    customClass: {
                        confirmButton: 'btn btn-warning'
                    },
                    buttonsStyling: false
                });
                return;
            }
            
            Swal.fire({
                title: '¿Eliminar producto?',
                text: 'Esta acción no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar',
                customClass: {
                    confirmButton: 'btn btn-danger',
                    cancelButton: 'btn btn-secondary'
                },
                buttonsStyling: false
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const producto = inventory.find(p => p.id === id);
                    if (producto) {
                        try {
                            if (isOnline && db) {
                                await deleteProductFromFirebase(id);
                            }
                            
                            await agregarAlHistorial(
                                'eliminacion',
                                id,
                                producto.bodega + producto.tienda,
                                'inventario',
                                'eliminado'
                            );
                            
                            inventory = inventory.filter(p => p.id !== id);
                            updateInventoryTable(searchInput.value);
                            updateStats();
                            updateProveedorSelects();
                            
                            Swal.fire({
                                title: 'Producto eliminado',
                                text: `El producto ${producto.name} ha sido eliminado`,
                                icon: 'success',
                                confirmButtonText: 'OK',
                                customClass: {
                                    confirmButton: 'btn btn-success'
                                },
                                buttonsStyling: false
                            });
                        } catch (error) {
                            Swal.fire({
                                title: 'Error',
                                text: 'No se pudo eliminar el producto. Inténtalo de nuevo.',
                                icon: 'error',
                                confirmButtonText: 'OK',
                                customClass: {
                                    confirmButton: 'btn btn-danger'
                                },
                                buttonsStyling: false
                            });
                        }
                    }
                }
            });
        }

        // Función para eliminar proveedor (solo admin)
        async function deleteProveedor(id) {
            if (currentUser.role !== 'admin') {
                Swal.fire({
                    title: 'Acceso denegado',
                    text: 'No tienes permisos para eliminar proveedores',
                    icon: 'warning',
                    confirmButtonText: 'Entendido',
                    customClass: {
                        confirmButton: 'btn btn-warning'
                    },
                    buttonsStyling: false
                });
                return;
            }
            
            Swal.fire({
                title: '¿Eliminar proveedor?',
                text: 'Esta acción no se puede deshacer. Los productos asociados a este proveedor no se eliminarán.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar',
                customClass: {
                    confirmButton: 'btn btn-danger',
                    cancelButton: 'btn btn-secondary'
                },
                buttonsStyling: false
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const proveedor = proveedores.find(p => p.id === id);
                    if (proveedor) {
                        try {
                            if (isOnline && db) {
                                await deleteProveedorFromFirebase(id);
                            }
                            
                            proveedores = proveedores.filter(p => p.id !== id);
                            updateProveedorSelects();
                            updateProveedoresList();
                            updateStats();
                            
                            Swal.fire({
                                title: 'Proveedor eliminado',
                                text: `El proveedor ${proveedor.nombre} ha sido eliminado`,
                                icon: 'success',
                                confirmButtonText: 'OK',
                                customClass: {
                                    confirmButton: 'btn btn-success'
                                },
                                buttonsStyling: false
                            });
                        } catch (error) {
                            Swal.fire({
                                title: 'Error',
                                text: 'No se pudo eliminar el proveedor. Inténtalo de nuevo.',
                                icon: 'error',
                                confirmButtonText: 'OK',
                                customClass: {
                                    confirmButton: 'btn btn-danger'
                                },
                                buttonsStyling: false
                            });
                        }
                    }
                }
            });
        }

        // Hacer funciones disponibles globalmente
        window.editProduct = editProduct;
        window.editProveedor = editProveedor;
        window.deleteProduct = deleteProduct;
        window.deleteProveedor = deleteProveedor;
        window.openTransferScanner = openTransferScanner;

        // ==============================================
        // INICIALIZACIÓN DE LA APLICACIÓN
        // ==============================================

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            
            // Configurar sistema de pestañas
            setupTabs();
            
            // Configurar eventos de búsqueda
            setupSearch();
            
            // Configurar búsqueda de proveedores
            setupProveedorSearch();
            
            // Configurar eventos de los botones
            setupEventListeners();
            
            // Configurar ordenamiento por clics en encabezados
            tableHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const sortField = this.getAttribute('data-sort');
                    sortByField(sortField);
                });
            });
            
            // Solicitar el rol al dashboard
            requestUserRole();
            
            // Verificar si hay sesión (por si acaso)
            const session = localStorage.getItem('userSession') || sessionStorage.getItem('userSession');
            if (!session) {
                window.location.href = 'login.html';
            }
        });

        // Configurar sistema de pestañas
        function setupTabs() {
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(`${tabId}Tab`).classList.add('active');
                    
                    if (tabId === 'proveedores') {
                        updateProveedorTable();
                    } else if (tabId === 'gestionProveedores') {
                        updateProveedoresList();
                    } else if (tabId === 'historial') {
                        updateHistorial();
                    } else if (tabId === 'informacion') {
                        updateStats();
                    }
                });
            });
        }

        // Configurar sistema de búsqueda
        function setupSearch() {
            searchInput.addEventListener('input', function() {
                updateInventoryTable(this.value);
            });
            
            proveedorProductSearch.addEventListener('input', function() {
                updateProveedorTable();
            });
        }

        // Función para contar productos por proveedor
        function contarProductosPorProveedor(proveedor) {
            return inventory.filter(product => product.proveedor === proveedor).length;
        }

        // Configurar búsqueda de proveedores
        function setupProveedorSearch() {
            let searchTimeout;
            
            proveedorSearchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const searchTerm = this.value.toLowerCase().trim();
                    const proveedoresList = getProveedoresUnicos();
                    proveedorSuggestions.innerHTML = '';
                    proveedorSuggestions.style.display = 'none';
                    
                    if (searchTerm.length === 0) {
                        currentProveedorFilter = null;
                        proveedorSelected.textContent = "Mostrando todos los proveedores";
                        updateProveedorTable();
                        return;
                    }
                    
                    const filteredProveedores = proveedoresList.filter(proveedor => 
                        proveedor.toLowerCase().includes(searchTerm)
                    );
                    
                    if (filteredProveedores.length > 0) {
                        filteredProveedores.forEach(proveedor => {
                            const count = contarProductosPorProveedor(proveedor);
                            const suggestion = document.createElement('div');
                            suggestion.className = 'proveedor-suggestion';
                            suggestion.innerHTML = `
                                <span>${proveedor}</span>
                                <span class="proveedor-count">${count} productos</span>
                            `;
                            suggestion.addEventListener('click', function() {
                                proveedorSearchInput.value = proveedor;
                                proveedorSuggestions.style.display = 'none';
                                currentProveedorFilter = proveedor;
                                const productCount = contarProductosPorProveedor(proveedor);
                                proveedorSelected.innerHTML = `
                                    <div class="proveedor-info-header">
                                        <span>Mostrando: ${proveedor}</span>
                                        <span class="proveedor-count-badge">${productCount} productos</span>
                                    </div>
                                `;
                                updateProveedorTable();
                            });
                            proveedorSuggestions.appendChild(suggestion);
                        });
                        proveedorSuggestions.style.display = 'block';
                    }
                    
                    if (filteredProveedores.length === 1 && searchTerm.length > 2) {
                        currentProveedorFilter = filteredProveedores[0];
                        const productCount = contarProductosPorProveedor(filteredProveedores[0]);
                        proveedorSelected.innerHTML = `
                            <div class="proveedor-info-header">
                                <span>Mostrando: ${filteredProveedores[0]}</span>
                                <span class="proveedor-count-badge">${productCount} productos</span>
                            </div>
                        `;
                        updateProveedorTable();
                    }
                }, 300);
            });
            
            document.addEventListener('click', function(event) {
                if (!proveedorSearchInput.contains(event.target) && !proveedorSuggestions.contains(event.target)) {
                    proveedorSuggestions.style.display = 'none';
                }
            });
            
            proveedorSearchInput.addEventListener('search', function() {
                if (this.value === '') {
                    currentProveedorFilter = null;
                    proveedorSelected.textContent = "Mostrando todos los proveedores";
                    updateProveedorTable();
                }
            });
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Botón de logout
            btnLogout.addEventListener('click', logout);

            // Configurar eventos de conexión
            window.addEventListener('online', async () => {
                updateConnectionStatus(true);
                if (currentUser) {
                    showLoadingSpinner();
                    await loadDataFromFirebase();
                }
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus(false);
            });

            // Configurar botones de actualizar
            btnRefresh.addEventListener('click', async function() {
                showLoadingSpinner();
                await loadDataFromFirebase();
            });
            
            btnRefreshProveedores.addEventListener('click', async function() {
                const originalText = btnRefreshProveedores.innerHTML;
                btnRefreshProveedores.innerHTML = '<span class="spinner"></span>';
                await loadDataFromFirebase();
                btnRefreshProveedores.innerHTML = originalText;
            });
            
            btnRefreshGestionProveedores.addEventListener('click', async function() {
                const originalText = btnRefreshGestionProveedores.innerHTML;
                btnRefreshGestionProveedores.innerHTML = '<span class="spinner"></span>';
                await loadDataFromFirebase();
                btnRefreshGestionProveedores.innerHTML = originalText;
            });
            
            btnRefreshActualizarStock.addEventListener('click', async function() {
                const originalText = btnRefreshActualizarStock.innerHTML;
                btnRefreshActualizarStock.innerHTML = '<span class="spinner"></span>';
                await loadDataFromFirebase();
                btnRefreshActualizarStock.innerHTML = originalText;
            });
            
            btnRefreshHistorial.addEventListener('click', async function() {
                const originalText = btnRefreshHistorial.innerHTML;
                btnRefreshHistorial.innerHTML = '<span class="spinner"></span>';
                await loadDataFromFirebase();
                btnRefreshHistorial.innerHTML = originalText;
            });
            
            btnRefreshImportar.addEventListener('click', async function() {
                const originalText = btnRefreshImportar.innerHTML;
                btnRefreshImportar.innerHTML = '<span class="spinner"></span>';
                await loadDataFromFirebase();
                btnRefreshImportar.innerHTML = originalText;
            });
            
            btnRefreshInformacion.addEventListener('click', async function() {
                const originalText = btnRefreshInformacion.innerHTML;
                btnRefreshInformacion.innerHTML = '<span class="spinner"></span>';
                await loadDataFromFirebase();
                btnRefreshInformacion.innerHTML = originalText;
            });
            
            // Configurar botón para agregar códigos de barras
            btnAddBarcode.addEventListener('click', function() {
                addBarcodeField();
            });
            
            // Botón agregar producto en inventario
            btnAddProductInventario?.addEventListener('click', function() {
                if (currentUser && currentUser.role !== 'admin') {
                    Swal.fire({
                        title: 'Acceso denegado',
                        text: 'No tienes permisos para agregar productos',
                        icon: 'warning',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-warning'
                        },
                        buttonsStyling: false
                    });
                    return;
                }
                
                editingProductId = null;
                document.getElementById('modalTitle').textContent = 'Agregar Producto';
                document.getElementById('productSKU').value = '';
                document.getElementById('productBarCode').value = '';
                document.getElementById('productName').value = '';
                document.getElementById('productProveedor').selectedIndex = 0;
                document.getElementById('stockBodega').value = '0';
                document.getElementById('stockTienda').value = '0';
                
                // Limpiar códigos de barras adicionales
                barcodesContainer.innerHTML = '';
                
                productModal.style.display = 'flex';
            });

            // Botón agregar producto en pestaña importar
            btnAddProductImportar?.addEventListener('click', function() {
                if (currentUser && currentUser.role !== 'admin') {
                    Swal.fire({
                        title: 'Acceso denegado',
                        text: 'No tienes permisos para agregar productos',
                        icon: 'warning',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-warning'
                        },
                        buttonsStyling: false
                    });
                    return;
                }
                
                editingProductId = null;
                document.getElementById('modalTitle').textContent = 'Agregar Producto';
                document.getElementById('productSKU').value = '';
                document.getElementById('productBarCode').value = '';
                document.getElementById('productName').value = '';
                document.getElementById('productProveedor').selectedIndex = 0;
                document.getElementById('stockBodega').value = '0';
                document.getElementById('stockTienda').value = '0';
                
                barcodesContainer.innerHTML = '';
                
                productModal.style.display = 'flex';
            });

            // Botón agregar proveedor
            btnAddProveedor.addEventListener('click', function() {
                if (currentUser && currentUser.role !== 'admin') {
                    Swal.fire({
                        title: 'Acceso denegado',
                        text: 'No tienes permisos para agregar proveedores',
                        icon: 'warning',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-warning'
                        },
                        buttonsStyling: false
                    });
                    return;
                }
                
                editingProveedorId = null;
                document.getElementById('proveedorModalTitle').textContent = 'Agregar Proveedor';
                document.getElementById('proveedorCodigo').value = '';
                document.getElementById('proveedorNombre').value = '';
                document.getElementById('proveedorDescripcion').value = '';
                document.getElementById('proveedorContacto').value = '';
                document.getElementById('proveedorTelefono').value = '';
                document.getElementById('proveedorEmail').value = '';
                proveedorModal.style.display = 'flex';
            });

            // Botón exportar proveedores
            btnExportarProveedores.addEventListener('click', function() {
                exportarProveedores();
            });

            // Botón exportar inventario por proveedor a Excel
            btnExportarProveedorExcel.addEventListener('click', function() {
                exportarInventarioPorProveedorExcel();
            });

            // Botón importar rápido en pestaña importar
            btnImportarRapidoImportar?.addEventListener('click', function() {
                if (currentUser && currentUser.role !== 'admin') {
                    Swal.fire({
                        title: 'Acceso denegado',
                        text: 'No tienes permisos para importar datos',
                        icon: 'warning',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-warning'
                        },
                        buttonsStyling: false
                    });
                    return;
                }
                importModal.style.display = 'flex';
            });

            // Buscar producto en modal de scanner
            btnBuscarProducto.addEventListener('click', function() {
                const termino = scannerInput.value.trim();
                if (!termino) {
                    Swal.fire({
                        title: 'Ingresa un código',
                        text: 'Por favor, ingresa un SKU, nombre o código de barras',
                        icon: 'info',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-primary'
                        },
                        buttonsStyling: false
                    });
                    return;
                }
                
                const producto = buscarProducto(termino);
                mostrarResultadoBusqueda(producto);
            });

            // Escanear automáticamente al presionar Enter
            scannerInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    btnBuscarProducto.click();
                }
            });

            // Limpiar scanner
            btnLimpiarScanner.addEventListener('click', function() {
                scannerInput.value = '';
                scannerResult.classList.remove('active');
                transferFormContainer.style.display = 'none';
                scannerInput.focus();
            });

            // Cerrar modales solo con el botón X
            closeModalBtn.addEventListener('click', function() {
                productModal.style.display = 'none';
            });

            closeScannerModalBtn.addEventListener('click', function() {
                scannerModal.style.display = 'none';
            });

            closeImportModalBtn.addEventListener('click', function() {
                importModal.style.display = 'none';
            });

            closeProveedorModalBtn.addEventListener('click', function() {
                proveedorModal.style.display = 'none';
            });

            // Manejar envío del formulario de producto
            productForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (btnSubmitProduct.disabled) return;
                const originalText = btnSubmitProduct.innerHTML;
                btnSubmitProduct.innerHTML = '<span class="spinner"></span> Guardando...';
                btnSubmitProduct.disabled = true;
                
                // Obtener códigos de barras adicionales
                const additionalBarcodes = [];
                const barcodeInputs = barcodesContainer.querySelectorAll('input[type="text"]');
                barcodeInputs.forEach(input => {
                    if (input.value.trim()) {
                        additionalBarcodes.push(input.value.trim());
                    }
                });
                
                const productData = {
                    id: editingProductId || nextId,
                    sku: document.getElementById('productSKU').value,
                    barcode: document.getElementById('productBarCode').value,
                    barcodes: additionalBarcodes.length > 0 ? additionalBarcodes : [document.getElementById('productBarCode').value],
                    name: document.getElementById('productName').value,
                    proveedor: document.getElementById('productProveedor').value,
                    bodega: parseInt(document.getElementById('stockBodega').value) || 0,
                    tienda: parseInt(document.getElementById('stockTienda').value) || 0,
                    lastTransfer: null
                };
                
                const skuExists = inventory.find(p => p.sku === productData.sku && p.id !== editingProductId);
                const barcodeExists = inventory.find(p => {
                    if (p.barcode === productData.barcode && p.id !== editingProductId) return true;
                    if (p.barcodes && Array.isArray(p.barcodes)) {
                        return p.barcodes.some(bc => productData.barcodes.includes(bc) && p.id !== editingProductId);
                    }
                    return false;
                });
                
                if (skuExists) {
                    Swal.fire({
                        title: 'SKU duplicado',
                        text: 'Ya existe un producto con este SKU',
                        icon: 'error',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-danger'
                        },
                        buttonsStyling: false
                    });
                    btnSubmitProduct.innerHTML = originalText;
                    btnSubmitProduct.disabled = false;
                    return;
                }
                
                if (barcodeExists) {
                    Swal.fire({
                        title: 'Código duplicado',
                        text: 'Ya existe un producto con este código de barras',
                        icon: 'error',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-danger'
                        },
                        buttonsStyling: false
                    });
                    btnSubmitProduct.innerHTML = originalText;
                    btnSubmitProduct.disabled = false;
                    return;
                }
                
                try {
                    const isUpdate = !!editingProductId;
                    if (isOnline && db) {
                        await saveProductToFirebase(productData, isUpdate);
                    }
                    
                    if (isUpdate) {
                        const index = inventory.findIndex(p => p.id === editingProductId);
                        inventory[index] = productData;
                        Swal.fire({
                            title: 'Producto actualizado',
                            text: `El producto ${productData.name} ha sido actualizado correctamente`,
                            icon: 'success',
                            confirmButtonText: 'OK',
                            customClass: {
                                confirmButton: 'btn btn-success'
                            },
                            buttonsStyling: false
                        });
                    } else {
                        inventory.push(productData);
                        nextId++;
                        await agregarAlHistorial(
                            'importacion',
                            productData.id,
                            productData.bodega + productData.tienda,
                            'sistema',
                            'inventario'
                        );
                        Swal.fire({
                            title: 'Producto agregado',
                            text: `El producto ${productData.name} ha sido agregado correctamente`,
                            icon: 'success',
                            confirmButtonText: 'OK',
                            customClass: {
                                confirmButton: 'btn btn-success'
                            },
                            buttonsStyling: false
                        });
                    }
                    
                    updateInventoryTable(searchInput.value);
                    updateStats();
                    updateProveedorSelects();
                    productModal.style.display = 'none';
                } catch (error) {
                    console.error('Error guardando producto:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'No se pudo guardar el producto. Inténtalo de nuevo.',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        customClass: {
                            confirmButton: 'btn btn-danger'
                        },
                        buttonsStyling: false
                    });
                } finally {
                    btnSubmitProduct.innerHTML = originalText;
                    btnSubmitProduct.disabled = false;
                }
            });

            // Manejar envío del formulario de proveedor
            proveedorForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (btnSubmitProveedor.disabled) return;
                const originalText = btnSubmitProveedor.innerHTML;
                btnSubmitProveedor.innerHTML = '<span class="spinner"></span> Guardando...';
                btnSubmitProveedor.disabled = true;
                
                const proveedorData = {
                    id: editingProveedorId || nextProveedorId,
                    codigo: document.getElementById('proveedorCodigo').value,
                    nombre: document.getElementById('proveedorNombre').value,
                    descripcion: document.getElementById('proveedorDescripcion').value,
                    contacto: document.getElementById('proveedorContacto').value,
                    telefono: document.getElementById('proveedorTelefono').value,
                    email: document.getElementById('proveedorEmail').value
                };
                
                const codigoExists = proveedores.find(p => p.codigo === proveedorData.codigo && p.id !== editingProveedorId);
                
                if (codigoExists) {
                    Swal.fire({
                        title: 'Código duplicado',
                        text: 'Ya existe un proveedor con este código',
                        icon: 'error',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-danger'
                        },
                        buttonsStyling: false
                    });
                    btnSubmitProveedor.innerHTML = originalText;
                    btnSubmitProveedor.disabled = false;
                    return;
                }
                
                try {
                    const isUpdate = !!editingProveedorId;
                    if (isOnline && db) {
                        await saveProveedorToFirebase(proveedorData, isUpdate);
                    }
                    
                    if (isUpdate) {
                        const index = proveedores.findIndex(p => p.id === editingProveedorId);
                        proveedores[index] = proveedorData;
                        Swal.fire({
                            title: 'Proveedor actualizado',
                            text: `El proveedor ${proveedorData.nombre} ha sido actualizado correctamente`,
                            icon: 'success',
                            confirmButtonText: 'OK',
                            customClass: {
                                confirmButton: 'btn btn-success'
                            },
                            buttonsStyling: false
                        });
                    } else {
                        proveedores.push(proveedorData);
                        nextProveedorId++;
                        Swal.fire({
                            title: 'Proveedor agregado',
                            text: `El proveedor ${proveedorData.nombre} ha sido agregado correctamente`,
                            icon: 'success',
                            confirmButtonText: 'OK',
                            customClass: {
                                confirmButton: 'btn btn-success'
                            },
                            buttonsStyling: false
                        });
                    }
                    
                    updateProveedorSelects();
                    updateProveedoresList();
                    proveedorModal.style.display = 'none';
                } catch (error) {
                    console.error('Error guardando proveedor:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'No se pudo guardar el proveedor. Inténtalo de nuevo.',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        customClass: {
                            confirmButton: 'btn btn-danger'
                        },
                        buttonsStyling: false
                    });
                } finally {
                    btnSubmitProveedor.innerHTML = originalText;
                    btnSubmitProveedor.disabled = false;
                }
            });

            // Manejar envío del formulario de transferencia
            transferForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (isTransferring) {
                    Swal.fire({
                        title: 'Transferencia en proceso',
                        text: 'Por favor espera a que se complete la transferencia actual',
                        icon: 'warning',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-warning'
                        },
                        buttonsStyling: false
                    });
                    return;
                }
                
                isTransferring = true;
                const originalText = btnSubmitTransfer.innerHTML;
                btnSubmitTransfer.innerHTML = '<span class="spinner"></span> Procesando...';
                btnSubmitTransfer.disabled = true;
                
                const productId = parseInt(transferProductIdInput.value);
                const transferType = transferTypeSelect.value;
                const quantity = parseInt(transferQuantityInput.value);
                const productIndex = inventory.findIndex(p => p.id === productId);
                if (productIndex === -1) {
                    isTransferring = false;
                    btnSubmitTransfer.innerHTML = originalText;
                    btnSubmitTransfer.disabled = false;
                    return;
                }
                
                const product = inventory[productIndex];
                let origen, destino;
                
                if (transferType === 'bodegaToTienda') {
                    if (quantity > product.bodega) {
                        Swal.fire({
                            title: 'Stock insuficiente',
                            text: `No hay suficiente stock en bodega. Disponible: ${product.bodega}`,
                            icon: 'warning',
                            confirmButtonText: 'Entendido',
                            customClass: {
                                confirmButton: 'btn btn-warning'
                            },
                            buttonsStyling: false
                        });
                        isTransferring = false;
                        btnSubmitTransfer.innerHTML = originalText;
                        btnSubmitTransfer.disabled = false;
                        return;
                    }
                    product.bodega -= quantity;
                    product.tienda += quantity;
                    product.lastTransfer = getCurrentTimestamp();
                    origen = 'bodega';
                    destino = 'tienda';
                } else {
                    if (quantity > product.tienda) {
                        Swal.fire({
                            title: 'Stock insuficiente',
                            text: `No hay suficiente stock en tienda. Disponible: ${product.tienda}`,
                            icon: 'warning',
                            confirmButtonText: 'Entendido',
                            customClass: {
                                confirmButton: 'btn btn-warning'
                            },
                            buttonsStyling: false
                        });
                        isTransferring = false;
                        btnSubmitTransfer.innerHTML = originalText;
                        btnSubmitTransfer.disabled = false;
                        return;
                    }
                    product.tienda -= quantity;
                    product.bodega += quantity;
                    origen = 'tienda';
                    destino = 'bodega';
                }
                
                try {
                    if (isOnline && db) {
                        await saveProductToFirebase(product, true);
                    }
                    
                    await agregarAlHistorial(
                        'transferencia',
                        productId,
                        quantity,
                        origen,
                        destino
                    );
                    
                    updateInventoryTable(searchInput.value);
                    updateStats();
                    scannerModal.style.display = 'none';
                    scannerInput.value = '';
                    scannerResult.classList.remove('active');
                    transferFormContainer.style.display = 'none';
                    
                    Swal.fire({
                        title: 'Transferencia exitosa',
                        html: `Se transfirieron <strong>${quantity} unidades</strong> de <strong>${product.name}</strong><br>de <strong>${origen}</strong> a <strong>${destino}</strong>`,
                        icon: 'success',
                        confirmButtonText: 'OK',
                        customClass: {
                            confirmButton: 'btn btn-success'
                        },
                        buttonsStyling: false
                    });
                } catch (error) {
                    console.error('Error en transferencia:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'No se pudo completar la transferencia. Inténtalo de nuevo.',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        customClass: {
                            confirmButton: 'btn btn-danger'
                        },
                        buttonsStyling: false
                    });
                } finally {
                    isTransferring = false;
                    btnSubmitTransfer.innerHTML = originalText;
                    btnSubmitTransfer.disabled = false;
                }
            });

            // Actualizar stock disponible al cambiar tipo de transferencia
            transferTypeSelect.addEventListener('change', function() {
                const productId = parseInt(transferProductIdInput.value);
                if (productId) {
                    updateAvailableStockForProduct(productId);
                }
            });

            // Configurar área de carga de archivos
            fileUploadArea.addEventListener('click', function() {
                if (currentUser && currentUser.role !== 'admin') {
                    Swal.fire({
                        title: 'Acceso denegado',
                        text: 'No tienes permisos para importar datos',
                        icon: 'warning',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-warning'
                        },
                        buttonsStyling: false
                    });
                    return;
                }
                jsonFileInput.click();
            });
            
            jsonFileInput.addEventListener('change', function(e) {
                if (this.files.length > 0) {
                    const fileName = this.files[0].name;
                    fileUploadArea.innerHTML = `
                        <i class="fas fa-file-check" style="color: var(--success);"></i>
                        <p>Archivo seleccionado: <strong>${fileName}</strong></p>
                        <p class="subtitle">Haz clic en "Importar Archivo JSON" para procesar</p>
                    `;
                }
            });

            // Importar archivo JSON
            btnImportarJSON.addEventListener('click', async function() {
                if (currentUser && currentUser.role !== 'admin') {
                    Swal.fire({
                        title: 'Acceso denegado',
                        text: 'No tienes permisos para importar datos',
                        icon: 'warning',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-warning'
                        },
                        buttonsStyling: false
                    });
                    return;
                }
                
                if (!jsonFileInput.files.length) {
                    Swal.fire({
                        title: 'Archivo requerido',
                        text: 'Por favor, selecciona un archivo JSON primero',
                        icon: 'info',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-info'
                        },
                        buttonsStyling: false
                    });
                    return;
                }
                
                const proveedor = importProveedor.value;
                const actualizarStock = importarActualizarStock.checked;
                
                if (!proveedor) {
                    Swal.fire({
                        title: 'Proveedor requerido',
                        text: 'Selecciona un proveedor para los productos',
                        icon: 'warning',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-warning'
                        },
                        buttonsStyling: false
                    });
                    return;
                }
                
                const originalText = btnImportarJSON.innerHTML;
                btnImportarJSON.innerHTML = '<span class="spinner"></span> Procesando...';
                btnImportarJSON.disabled = true;
                
                try {
                    const file = jsonFileInput.files[0];
                    const data = await readFileAsJSON(file);
                    
                    let productosImportados = 0;
                    let productosActualizados = 0;
                    
                    if (Array.isArray(data)) {
                        for (const item of data) {
                            let producto;
                            
                            if (item.SKU !== undefined) {
                                producto = {
                                    id: nextId++,
                                    sku: item.SKU || item.sku || `IMP${nextId}`,
                                    name: item.Producto || item.producto || item.Nombre || item.nombre || 'Producto sin nombre',
                                    barcode: item['Cód. Barra'] || item.codigoBarra || item.barcode || item.SKU || '',
                                    barcodes: [item['Cód. Barra'] || item.codigoBarra || item.barcode || item.SKU || ''],
                                    proveedor: item.Proveedor || item.proveedor || proveedor,
                                    bodega: parseInt(item.Existencia) || parseInt(item.existencia) || parseInt(item.bodega) || 0,
                                    tienda: parseInt(item.tienda) || 0,
                                    lastTransfer: null
                                };
                            } else if (item.sku !== undefined) {
                                producto = {
                                    id: nextId++,
                                    sku: item.sku,
                                    name: item.producto || item.nombre,
                                    barcode: item.barcode || item.codigoBarra || item.sku,
                                    barcodes: [item.barcode || item.codigoBarra || item.sku],
                                    proveedor: item.proveedor || proveedor,
                                    bodega: parseInt(item.existencia) || parseInt(item.bodega) || 0,
                                    tienda: parseInt(item.tienda) || 0,
                                    lastTransfer: null
                                };
                            }
                            
                            if (producto) {
                                const existingIndex = inventory.findIndex(p => p.sku === producto.sku);
                                
                                if (existingIndex >= 0) {
                                    if (actualizarStock) {
                                        inventory[existingIndex].bodega = producto.bodega;
                                        inventory[existingIndex].tienda = producto.tienda;
                                        inventory[existingIndex].proveedor = proveedor;
                                    } else {
                                        inventory[existingIndex].bodega += producto.bodega;
                                    }
                                    productosActualizados++;
                                    if (isOnline && db) {
                                        await saveProductToFirebase(inventory[existingIndex], true);
                                    }
                                } else {
                                    if (isOnline && db) {
                                        await saveProductToFirebase(producto, false);
                                    }
                                    inventory.push(producto);
                                    productosImportados++;
                                }
                            }
                        }
                    }
                    
                    if (productosImportados > 0 || productosActualizados > 0) {
                        await agregarAlHistorial(
                            'importacion',
                            null,
                            productosImportados + productosActualizados,
                            'archivo_json',
                            'inventario'
                        );
                        
                        updateInventoryTable(searchInput.value);
                        updateStats();
                        updateProveedorSelects();
                        fileUploadArea.innerHTML = `
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Arrastra y suelta tu archivo JSON aquí o haz clic para seleccionar</p>
                            <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
                            <p class="subtitle" style="margin-top: 10px;">Formato esperado: SKU, Producto, Cód. Barra, Existencia</p>
                        `;
                        jsonFileInput.value = '';
                        
                        document.getElementById('jsonFileInput').addEventListener('change', function(e) {
                            if (this.files.length > 0) {
                                const fileName = this.files[0].name;
                                fileUploadArea.innerHTML = `
                                    <i class="fas fa-file-check" style="color: var(--success);"></i>
                                    <p>Archivo seleccionado: <strong>${fileName}</strong></p>
                                    <p class="subtitle">Haz clic en "Importar Archivo JSON" para procesar</p>
                                `;
                            }
                        });
                        
                        Swal.fire({
                            title: 'Importación exitosa',
                            html: `Se procesaron <strong>${productosImportados + productosActualizados}</strong> productos del archivo JSON<br>
                                  <strong>${productosImportados}</strong> nuevos<br>
                                  <strong>${productosActualizados}</strong> actualizados`,
                            icon: 'success',
                            confirmButtonText: 'OK',
                            customClass: {
                                confirmButton: 'btn btn-success'
                            },
                            buttonsStyling: false
                        });
                    } else {
                        Swal.fire({
                            title: 'Error en formato',
                            text: 'No se pudieron procesar los datos del archivo JSON. Verifica el formato.',
                            icon: 'error',
                            confirmButtonText: 'Entendido',
                            customClass: {
                                confirmButton: 'btn btn-danger'
                            },
                            buttonsStyling: false
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        title: 'Error al procesar',
                        text: 'Error al procesar el archivo JSON: ' + error.message,
                        icon: 'error',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-danger'
                        },
                        buttonsStyling: false
                    });
                } finally {
                    btnImportarJSON.innerHTML = originalText;
                    btnImportarJSON.disabled = false;
                }
            });

            // Procesar importación rápida
            btnProcesarImportacion.addEventListener('click', async function() {
                if (currentUser && currentUser.role !== 'admin') {
                    Swal.fire({
                        title: 'Acceso denegado',
                        text: 'No tienes permisos para importar datos',
                        icon: 'warning',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-warning'
                        },
                        buttonsStyling: false
                    });
                    return;
                }
                
                const datos = importDataTextarea.value.trim();
                const proveedor = importRapidoProveedor.value;
                const actualizarStock = importRapidoActualizarStock.checked;
                
                if (!datos) {
                    Swal.fire({
                        title: 'Datos vacíos',
                        text: 'Por favor, ingresa datos para importar',
                        icon: 'info',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-info'
                        },
                        buttonsStyling: false
                    });
                    return;
                }
                
                if (!proveedor) {
                    Swal.fire({
                        title: 'Proveedor requerido',
                        text: 'Selecciona un proveedor para los productos',
                        icon: 'warning',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-warning'
                        },
                        buttonsStyling: false
                    });
                    return;
                }
                
                const originalText = btnProcesarImportacion.innerHTML;
                btnProcesarImportacion.innerHTML = '<span class="spinner"></span> Procesando...';
                btnProcesarImportacion.disabled = true;
                
                try {
                    const lineas = datos.split('\n');
                    let productosImportados = 0;
                    let productosActualizados = 0;
                    
                    for (const linea of lineas) {
                        const lineaTrim = linea.trim();
                        if (!lineaTrim) continue;
                        
                        let partes;
                        if (lineaTrim.includes('|')) {
                            partes = lineaTrim.split('|').map(p => p.trim());
                        } else if (lineaTrim.includes('\t')) {
                            partes = lineaTrim.split('\t').map(p => p.trim());
                        } else {
                            partes = lineaTrim.split(/\s{2,}/).map(p => p.trim());
                        }
                        
                        if (partes.length >= 4) {
                            const [sku, nombre, barcode, existencia] = partes;
                            const existingIndex = inventory.findIndex(p => p.sku === sku);
                            
                            if (existingIndex >= 0) {
                                if (actualizarStock) {
                                    inventory[existingIndex].bodega = parseInt(existencia) || 0;
                                    inventory[existingIndex].tienda = 0;
                                    inventory[existingIndex].proveedor = proveedor;
                                } else {
                                    inventory[existingIndex].bodega += parseInt(existencia) || 0;
                                }
                                productosActualizados++;
                                if (isOnline && db) {
                                    await saveProductToFirebase(inventory[existingIndex], true);
                                }
                            } else {
                                const nuevoProducto = {
                                    id: nextId++,
                                    sku: sku,
                                    name: nombre,
                                    barcode: barcode,
                                    barcodes: [barcode],
                                    proveedor: proveedor,
                                    bodega: parseInt(existencia) || 0,
                                    tienda: 0,
                                    lastTransfer: null
                                };
                                if (isOnline && db) {
                                    await saveProductToFirebase(nuevoProducto, false);
                                }
                                inventory.push(nuevoProducto);
                                productosImportados++;
                            }
                        }
                    }
                    
                    if (productosImportados > 0 || productosActualizados > 0) {
                        await agregarAlHistorial(
                            'importacion',
                            null,
                            productosImportados + productosActualizados,
                            'importacion_rapida',
                            'inventario'
                        );
                        
                        updateInventoryTable(searchInput.value);
                        updateStats();
                        updateProveedorSelects();
                        importModal.style.display = 'none';
                        
                        Swal.fire({
                            title: 'Importación exitosa',
                            html: `Se procesaron <strong>${productosImportados + productosActualizados}</strong> productos<br>
                                  <strong>${productosImportados}</strong> nuevos<br>
                                  <strong>${productosActualizados}</strong> actualizados`,
                            icon: 'success',
                            confirmButtonText: 'OK',
                            customClass: {
                                confirmButton: 'btn btn-success'
                            },
                            buttonsStyling: false
                        });
                    } else {
                        Swal.fire({
                            title: 'Error en formato',
                            text: 'No se pudieron procesar los datos. Verifica el formato.',
                            icon: 'error',
                            confirmButtonText: 'Entendido',
                            customClass: {
                                confirmButton: 'btn btn-danger'
                            },
                            buttonsStyling: false
                        });
                    }
                } catch (error) {
                    console.error('Error en importación rápida:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'No se pudo completar la importación. Inténtalo de nuevo.',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        customClass: {
                            confirmButton: 'btn btn-danger'
                        },
                        buttonsStyling: false
                    });
                } finally {
                    btnProcesarImportacion.innerHTML = originalText;
                    btnProcesarImportacion.disabled = false;
                }
            });

            // Procesar actualización de stock
            btnProcesarActualizacion.addEventListener('click', async function() {
                if (currentUser && currentUser.role !== 'admin') {
                    Swal.fire({
                        title: 'Acceso denegado',
                        text: 'No tienes permisos para actualizar stock',
                        icon: 'warning',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-warning'
                        },
                        buttonsStyling: false
                    });
                    return;
                }
                
                const datos = actualizarStockData.value.trim();
                const soloBodega = actualizarSoloBodega.checked;
                
                if (!datos) {
                    Swal.fire({
                        title: 'Datos vacíos',
                        text: 'Por favor, ingresa datos para actualizar stock',
                        icon: 'info',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-info'
                        },
                        buttonsStyling: false
                    });
                    return;
                }
                
                const originalText = btnProcesarActualizacion.innerHTML;
                btnProcesarActualizacion.innerHTML = '<span class="spinner"></span> Procesando...';
                btnProcesarActualizacion.disabled = true;
                
                try {
                    const lineas = datos.split('\n');
                    let productosActualizados = 0;
                    let productosNoEncontrados = 0;
                    let resultados = [];
                    
                    for (const linea of lineas) {
                        const lineaTrim = linea.trim();
                        if (!lineaTrim) continue;
                        
                        let partes;
                        if (lineaTrim.includes('|')) {
                            partes = lineaTrim.split('|').map(p => p.trim());
                        } else if (lineaTrim.includes('\t')) {
                            partes = lineaTrim.split('\t').map(p => p.trim());
                        } else {
                            partes = lineaTrim.split(/\s{2,}/).map(p => p.trim());
                        }
                        
                        if (partes.length >= 2) {
                            const [sku, existenciaBodega, existenciaTienda] = partes;
                            const existingIndex = inventory.findIndex(p => p.sku === sku);
                            
                            if (existingIndex >= 0) {
                                const producto = inventory[existingIndex];
                                const viejoBodega = producto.bodega;
                                const viejoTienda = producto.tienda;
                                
                                if (soloBodega) {
                                    producto.bodega = parseInt(existenciaBodega) || 0;
                                } else {
                                    producto.bodega = parseInt(existenciaBodega) || 0;
                                    producto.tienda = parseInt(existenciaTienda) || 0;
                                }
                                
                                if (isOnline && db) {
                                    await saveProductToFirebase(producto, true);
                                }
                                
                                productosActualizados++;
                                resultados.push({
                                    sku: sku,
                                    nombre: producto.name,
                                    viejoBodega: viejoBodega,
                                    viejoTienda: viejoTienda,
                                    nuevoBodega: producto.bodega,
                                    nuevoTienda: producto.tienda
                                });
                            } else {
                                productosNoEncontrados++;
                                resultados.push({
                                    sku: sku,
                                    error: 'Producto no encontrado'
                                });
                            }
                        }
                    }
                    
                    if (productosActualizados > 0) {
                        await agregarAlHistorial(
                            'actualizacion_stock',
                            null,
                            productosActualizados,
                            'sistema',
                            'inventario'
                        );
                        
                        updateInventoryTable(searchInput.value);
                        updateStats();
                        mostrarResultadosActualizacion(resultados, productosActualizados, productosNoEncontrados);
                        
                        Swal.fire({
                            title: 'Actualización exitosa',
                            html: `Se actualizaron <strong>${productosActualizados}</strong> productos<br>
                                  <strong>${productosNoEncontrados}</strong> productos no encontrados`,
                            icon: 'success',
                            confirmButtonText: 'OK',
                            customClass: {
                                confirmButton: 'btn btn-success'
                            },
                            buttonsStyling: false
                        });
                    } else if (productosNoEncontrados > 0) {
                        Swal.fire({
                            title: 'Productos no encontrados',
                            text: `No se encontraron ${productosNoEncontrados} productos en el inventario.`,
                            icon: 'warning',
                            confirmButtonText: 'Entendido',
                            customClass: {
                                confirmButton: 'btn btn-warning'
                            },
                            buttonsStyling: false
                        });
                    } else {
                        Swal.fire({
                            title: 'Error en formato',
                            text: 'No se pudieron procesar los datos. Verifica el formato.',
                            icon: 'error',
                            confirmButtonText: 'Entendido',
                            customClass: {
                                confirmButton: 'btn btn-danger'
                            },
                            buttonsStyling: false
                        });
                    }
                } catch (error) {
                    console.error('Error en actualización de stock:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'No se pudo completar la actualización. Inténtalo de nuevo.',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        customClass: {
                            confirmButton: 'btn btn-danger'
                        },
                        buttonsStyling: false
                    });
                } finally {
                    btnProcesarActualizacion.innerHTML = originalText;
                    btnProcesarActualizacion.disabled = false;
                }
            });

            // Exportar datos
            btnExportarJSON.addEventListener('click', function() {
                const format = exportFormatSelect.value;
                
                if (format === 'excel') {
                    exportarAExcel();
                    return;
                }
                
                let data, filename, contentType;
                
                if (format === 'json') {
                    data = JSON.stringify({
                        inventario: inventory,
                        historial: historial,
                        proveedores: proveedores,
                        exportado: getCurrentTimestamp(),
                        totalProductos: inventory.length,
                        totalMovimientos: historial.length,
                        totalProveedores: proveedores.length
                    }, null, 2);
                    filename = `inventario_completo_${new Date().toISOString().split('T')[0]}.json`;
                    contentType = 'application/json';
                } else if (format === 'formatoProveedor') {
                    let contenido = `Proveedor: P00111 - STAMPO INTERNACIONAL, S.A\n\n`;
                    contenido += `SKU\tProducto\tCód. Barra\tExistencia\n`;
                    inventory.forEach(producto => {
                        contenido += `${producto.sku}\t${producto.name}\t${producto.barcode}\t${producto.bodega + producto.tienda}\n`;
                    });
                    data = contenido;
                    filename = `inventario_proveedor_${new Date().toISOString().split('T')[0]}.txt`;
                    contentType = 'text/plain';
                } else if (format === 'csv') {
                    let contenido = 'SKU,Producto,Cód. Barra,Proveedor,Bodega,Tienda,Último Envío,Total\n';
                    inventory.forEach(producto => {
                        const ultimoEnvio = producto.lastTransfer ? 
                            formatFullDate(producto.lastTransfer) : "";
                        contenido += `${producto.sku},${producto.name},${producto.barcode},${producto.proveedor},${producto.bodega},${producto.tienda},${ultimoEnvio},${producto.bodega + producto.tienda}\n`;
                    });
                    data = contenido;
                    filename = `inventario_${new Date().toISOString().split('T')[0]}.csv`;
                    contentType = 'text/csv';
                }
                
                const blob = new Blob([data], { type: contentType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                agregarAlHistorial(
                    'exportacion',
                    null,
                    inventory.length,
                    'sistema',
                    'archivo'
                );
                
                Swal.fire({
                    title: 'Exportación exitosa',
                    text: `Los datos se han exportado en formato ${format.toUpperCase()}`,
                    icon: 'success',
                    confirmButtonText: 'OK',
                    customClass: {
                        confirmButton: 'btn btn-success'
                    },
                    buttonsStyling: false
                });
            });

            // Limpiar historial
            btnLimpiarHistorial.addEventListener('click', async function() {
                if (currentUser && currentUser.role !== 'admin') {
                    Swal.fire({
                        title: 'Acceso denegado',
                        text: 'No tienes permisos para limpiar el historial',
                        icon: 'warning',
                        confirmButtonText: 'Entendido',
                        customClass: {
                            confirmButton: 'btn btn-warning'
                        },
                        buttonsStyling: false
                    });
                    return;
                }
                
                Swal.fire({
                    title: '¿Limpiar historial?',
                    text: 'Todos los registros de movimientos serán eliminados',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, limpiar',
                    cancelButtonText: 'Cancelar',
                    customClass: {
                        confirmButton: 'btn btn-danger',
                        cancelButton: 'btn btn-secondary'
                    },
                    buttonsStyling: false
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            if (isOnline && db) {
                                await clearHistoryFromFirebase();
                            }
                            historial = [];
                            updateHistorial();
                            updateStats();
                            
                            Swal.fire({
                                title: 'Historial limpiado',
                                text: 'Todos los registros han sido eliminados',
                                icon: 'success',
                                confirmButtonText: 'OK',
                                customClass: {
                                    confirmButton: 'btn btn-success'
                                },
                                buttonsStyling: false
                            });
                        } catch (error) {
                            Swal.fire({
                                title: 'Error',
                                text: 'No se pudo limpiar el historial. Inténtalo de nuevo.',
                                icon: 'error',
                                confirmButtonText: 'OK',
                                customClass: {
                                    confirmButton: 'btn btn-danger'
                                },
                                buttonsStyling: false
                            });
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>
